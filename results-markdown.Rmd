---
title: "R Notebook"
output:
  word_document: default
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r}
library(mice)
library(pander)
library(xtable)
library(dplyr)
library(gt)
library(glue)
library(tidyverse)
library(miceadds)
library(swfscMisc)
library(imputools)
library(haven)
library(sjmisc)
library(Hmisc)
library(psych)
library(lavaan)
library(ggplot2)
library(ggpubr)
library(officer)
library(flextable)
library(ftExtra)

#this will take a float (e.g. a p value) and return a string with 3 digits and no leading 0

bv <- function(val) {
  return(sub("^(-?)0.", "\\1.", sprintf("%.2f", val)))
}

#if the number is less than .001, it will give <.001. 
pv1 <- function(val) {
  return(paste("=", sub("^(-?)0.", "\\1.", sprintf("%.3f", val))))
}

```

RQ1 & 2 - DOES VOCAB PREDICT EDUCATIONAL ATTAINMENT?

1. Binary Outcome variable ####
1a. does vocabulary predict reaching a functional level in core subjects?
remember, having grade 4/c above in core subjects is the reference category.

```{r}
#unadjusted relationship

binary_unadjusted = with(imputed_mcs2, glm(benchmark_binary ~ age5_standardised,
                                        family = binomial,  weights = weight))

binary_unadjusted_results = summary(pool(binary_unadjusted), conf.int = TRUE, exponentiate = TRUE)

# adjusted relationship
binary_model1 = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + imd, 
                                       family = binomial, weights = weight))

binary_model2 = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + 
                                         imd + caregiver_vocabStandardised, 
                                       family = binomial, weights = weight))

binary_model3 = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + 
                                         imd + caregiver_vocabStandardised + age5_standardised, 
                                       family = binomial, weights = weight))

binary_model1Results = summary(pool(binary_model1), conf.int = TRUE, exponentiate = TRUE)
binary_model2Results = summary(pool(binary_model2), conf.int = TRUE, exponentiate = TRUE)
binary_model3Results = summary(pool(binary_model3), conf.int = TRUE, exponentiate = TRUE)
```

1b. does vocabulary predict reaching a functional level of education above and beyond SEC/caregiver vocab factors?
```{r}
#compare model with only sociodemographic factors to a model with caregiver vocab
D1(binary_model2, binary_model1) #check if need to use a specific method ?
#compare model with all confounders to model with vocab
D1(binary_model3, binary_model2) 
```

2. Continuous outcome variable####
2a does vocabulary predict level of achievement in core subjects regardless of pass/ fail? 

```{r}
#unadjusted relationship

continuous_unadjusted = with(imputed_mcs2, lm(standardised_core_subjects ~ age5_standardised, weights = weight))

continuous_unadjusted_results = summary(pool(continuous_unadjusted), conf.int = TRUE)

#adjusted relationship 
continuous_model1 = with(imputed_mcs2, lm(standardised_core_subjects ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + imd, 
                                       weights = weight))

continuous_model2 = with(imputed_mcs2, lm(standardised_core_subjects ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + 
                                         imd + caregiver_vocabStandardised, 
                                        weights = weight))

continuous_model3 = with(imputed_mcs2, lm(standardised_core_subjects ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + 
                                         imd + caregiver_vocabStandardised + age5_standardised, 
                                        weights = weight))

continuous_model1Results = summary(pool(continuous_model1), conf.int = TRUE)
continuous_model2Results = summary(pool(continuous_model2), conf.int = TRUE)
continuous_model3Results = summary(pool(continuous_model3), conf.int = TRUE)

round(pool.r.squared(continuous_unadjusted),4)*100
cont_model1R2 = as.data.frame(round(pool.r.squared(continuous_model1),4)*100)
cont_model2R2 = as.data.frame(round(pool.r.squared(continuous_model2),4)*100)
cont_model3R2 = as.data.frame(round(pool.r.squared(continuous_model3),4)*100)
```

2b. does vocabulary predict level of achievement in core subjects above and beyond SEC/caregiver vocab factors?

```{r}
#compare model with only sociodemographic factors to a model with caregiver vocab
D1(continuous_model2, continuous_model1) #check if need to use a specific method ?
#compare model with all confounders to model with vocab
D1(continuous_model3, continuous_model2) 
```

gather relevant information for table for RQ 1 & 2

```{r}
#binary outcome ####
#model 1 for binary outcome
binary_model1Results$estimate = bv(binary_model1Results$estimate) #no leading 0 
binary_model1Results$`2.5 %` = bv(binary_model1Results$`2.5 %`)
binary_model1Results$`97.5 %` = bv(binary_model1Results$`97.5 %`)
binary_model1Results$p.value1= ifelse(binary_model1Results$p.value< .001, "<.001" , pv1(binary_model1Results$p.value))
binary_model1Results$coefficient = paste0(binary_model1Results$estimate, "[", binary_model1Results$`2.5 %`, ";", binary_model1Results$`97.5 %`, "]")
binary_model1Results$stars = add.significance.stars(binary_model1Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
binary_model1Results$p1 = paste0(binary_model1Results$p.value1, "")
binary_model1Results$p = paste0("p", binary_model1Results$p1)
binary_model1Results$new_coef = paste0(binary_model1Results$coefficient, binary_model1Results$stars)  #combine coefficients and stars into column.

#model 2 for binary outcome
binary_model2Results$estimate = bv(binary_model2Results$estimate) #no leading 0 
binary_model2Results$`2.5 %` = bv(binary_model2Results$`2.5 %`)
binary_model2Results$`97.5 %` = bv(binary_model2Results$`97.5 %`)
binary_model2Results$p.value1= ifelse(binary_model2Results$p.value< .001, "<.001" , pv1(binary_model2Results$p.value))
binary_model2Results$coefficient = paste0(binary_model2Results$estimate, "[", binary_model2Results$`2.5 %`, ";", binary_model2Results$`97.5 %`, "]")
binary_model2Results$stars = add.significance.stars(binary_model2Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
binary_model2Results$p1 = paste0(binary_model2Results$p.value1, "")
binary_model2Results$p = paste0("p", binary_model2Results$p1)
binary_model2Results$new_coef = paste0(binary_model2Results$coefficient, binary_model2Results$stars)  #combine coefficients and stars into column.

#model 3 for binary outcome
binary_model3Results$estimate = bv(binary_model3Results$estimate) #no leading 0 
binary_model3Results$`2.5 %` = bv(binary_model3Results$`2.5 %`)
binary_model3Results$`97.5 %` = bv(binary_model3Results$`97.5 %`)
binary_model3Results$p.value1= ifelse(binary_model3Results$p.value< .001, "<.001" , pv1(binary_model3Results$p.value))
binary_model3Results$coefficient = paste0(binary_model3Results$estimate, "[", binary_model3Results$`2.5 %`, ";", binary_model3Results$`97.5 %`, "]")
binary_model3Results$stars = add.significance.stars(binary_model3Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
binary_model3Results$p1 = paste0(binary_model3Results$p.value1, "")
binary_model3Results$p = paste0("p", binary_model3Results$p1)
binary_model3Results$new_coef = paste0(binary_model3Results$coefficient, binary_model3Results$stars)  #combine coefficients and stars into column.

#contunous outcome ####
#model 1 for continuous outcome
continuous_model1Results$estimate = bv(continuous_model1Results$estimate) #no leading 0 
continuous_model1Results$`2.5 %` = bv(continuous_model1Results$`2.5 %`)
continuous_model1Results$`97.5 %` = bv(continuous_model1Results$`97.5 %`)
continuous_model1Results$p.value1= ifelse(continuous_model1Results$p.value< .001, "<.001" , pv1(continuous_model1Results$p.value))
continuous_model1Results$coefficient = paste0(continuous_model1Results$estimate, "[", continuous_model1Results$`2.5 %`, ";", continuous_model1Results$`97.5 %`, "]")
continuous_model1Results$stars = add.significance.stars(continuous_model1Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
continuous_model1Results$p1 = paste0(continuous_model1Results$p.value1, "")
continuous_model1Results$p = paste0("p", continuous_model1Results$p1)
continuous_model1Results$new_coef = paste0(continuous_model1Results$coefficient, continuous_model1Results$stars)  #combine coefficients and stars into column.

#model 2 for continuous outcome
continuous_model2Results$estimate = bv(continuous_model2Results$estimate) #no leading 0 
continuous_model2Results$`2.5 %` = bv(continuous_model2Results$`2.5 %`)
continuous_model2Results$`97.5 %` = bv(continuous_model2Results$`97.5 %`)
continuous_model2Results$p.value1= ifelse(continuous_model2Results$p.value< .001, "<.001" , pv1(continuous_model2Results$p.value))
continuous_model2Results$coefficient = paste0(continuous_model2Results$estimate, "[", continuous_model2Results$`2.5 %`, ";", continuous_model2Results$`97.5 %`, "]")
continuous_model2Results$stars = add.significance.stars(continuous_model2Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
continuous_model2Results$p1 = paste0(continuous_model2Results$p.value1, "")
continuous_model2Results$p = paste0("p", continuous_model2Results$p1)
continuous_model2Results$new_coef = paste0(continuous_model2Results$coefficient, continuous_model2Results$stars)  #combine coefficients and stars into column.


#model 3 for continuous outcome
continuous_model3Results$estimate = bv(continuous_model3Results$estimate) #no leading 0 
continuous_model3Results$`2.5 %` = bv(continuous_model3Results$`2.5 %`)
continuous_model3Results$`97.5 %` = bv(continuous_model3Results$`97.5 %`)
continuous_model3Results$p.value1= ifelse(continuous_model3Results$p.value< .001, "<.001" , pv1(continuous_model3Results$p.value))
continuous_model3Results$coefficient = paste0(continuous_model3Results$estimate, "[", continuous_model3Results$`2.5 %`, ";", continuous_model3Results$`97.5 %`, "]")
continuous_model3Results$stars = add.significance.stars(continuous_model3Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
continuous_model3Results$p1 = paste0(continuous_model3Results$p.value1, "")
continuous_model3Results$p = paste0("p", continuous_model3Results$p1)
continuous_model3Results$new_coef = paste0(continuous_model3Results$coefficient, continuous_model3Results$stars)  #combine coefficients and stars into column.


#get odds ratios and 95% CIs for table: logistic regression
binary_model1Results = binary_model1Results %>% select(term, new_coef, p)
binary_model2Results = binary_model2Results %>% select(term, new_coef, p)
binary_model3Results = binary_model3Results %>% select(term, new_coef, p)

binary_model1Results$model1_OR <- paste0(binary_model1Results$new_coef,"\n", binary_model1Results$p) 
binary_model2Results$model2_OR <- paste0(binary_model2Results$new_coef,"\n", binary_model2Results$p) 
binary_model3Results$model3_OR <- paste0(binary_model3Results$new_coef,"\n", binary_model3Results$p) 

binary_model1Results = binary_model1Results %>% select(term, model1_OR)
binary_model2Results = binary_model2Results %>% select(term, model2_OR)
binary_model3Results = binary_model3Results %>% select(term, model3_OR)

#add column to make it the same length for all 3 models - needs to be as long as model 3 
binary_model1Results = binary_model1Results %>% add_row(term = "caregiver_vocabStandardised") %>% 
  add_row(term = "age5_standardised")
binary_model2Results = binary_model2Results %>% add_row(term = "age5_standardised")

binary_outcomeResults = cbind(binary_model1Results, binary_model2Results, binary_model3Results)
binary_outcomeResults = binary_outcomeResults %>% select(!3 & !5)

binary_outcomeResults = binary_outcomeResults %>% add_row(term = "Sociodemographic confounders", .after = 1) %>% 
  add_row(term = "Caregiver vocabulary", .before = 39) %>% 
  add_row(term = "Cohort member vocabulary", .before  = 41) %>% 
  add_row(term = "R2", .after = 43)

#get coefficients and 95% CIs for table: linear regression
continuous_model1Results = continuous_model1Results %>% select(term, new_coef, p)
continuous_model2Results = continuous_model2Results %>% select(term, new_coef, p)
continuous_model3Results = continuous_model3Results %>% select(term, new_coef, p)

continuous_model1Results$model1_b <- paste0(continuous_model1Results$new_coef,"\n", continuous_model1Results$p) 
continuous_model2Results$model2_b <- paste0(continuous_model2Results$new_coef,"\n", continuous_model2Results$p) 
continuous_model3Results$model3_b <- paste0(continuous_model3Results$new_coef,"\n", continuous_model3Results$p) 

continuous_model1Results = continuous_model1Results %>% select(term, model1_b)
continuous_model2Results = continuous_model2Results %>% select(term, model2_b)
continuous_model3Results = continuous_model3Results %>% select(term, model3_b)


#add column to make it the same length for all 3 models - needs to be as long as model 3 
continuous_model1Results = continuous_model1Results %>% add_row(term = "caregiver_vocabStandardised") %>% 
  add_row(term = "age5_standardised") %>% 
  add_row(term = "R2", model1_b =paste0(cont_model1R2$est,"[", cont_model1R2$`lo 95`, ";", cont_model1R2$`hi 95`,"]"), .after = 39)
continuous_model2Results = continuous_model2Results %>% add_row(term = "age5_standardised") %>% 
  add_row(term = "R2", model2_b =paste0(cont_model2R2$est,"[", cont_model2R2$`lo 95`, ";", cont_model2R2$`hi 95`,"]"), .after = 39)
continuous_model3Results = continuous_model3Results %>% 
  add_row(term = "R2", model3_b =paste0(cont_model3R2$est,"[", cont_model3R2$`lo 95`, ";", cont_model3R2$`hi 95`,"]"), .after = 39)

continuous_outcomeResults = cbind(continuous_model1Results, continuous_model2Results, continuous_model3Results)
continuous_outcomeResults = continuous_outcomeResults %>% select(!3 & !5)

continuous_outcomeResults = continuous_outcomeResults %>% add_row(term = "Sociodemographic confounders", .after = 1) %>% 
  add_row(term = "Caregiver vocabulary", .before = 39) %>% 
  add_row(term = "Cohort member vocabulary", .before  = 41)


regression_resultsTable = cbind(binary_outcomeResults, continuous_outcomeResults)
regression_resultsTable [is.na(regression_resultsTable )] <- "  "
regression_resultsTable = regression_resultsTable %>% select(!5) %>%  
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .after = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .after = 3) %>% 
  add_row(term = "EAL1", .after = 9) %>% 
  add_row(term = "country1", .after =  12) %>% 
  add_row(term = "highest_nvq1", .after = 16) %>% 
  add_row(term = "oecd_income1", .after = 22) %>% 
  add_row(term = "occupational_status2", .after = 27) %>% 
  add_row(term = "wealth_quintiles1", .after = 31) %>% 
  add_row(term = "imd1", .after = 36 )
regression_resultsTable [is.na(regression_resultsTable )] <- "REFERENCE"
  
#rename variables column 

regression_resultsTable$term <- c("Sociodemographic confounders", "Sex (male)", "Sex (female)", 
                                  "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                                  "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                                  "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)",
                                  "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)", 
                           "Income Quintile 1", "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5", 
                          "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5", "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)",  
                          "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)", "Caregiver Vocabulary", "Caregiver Vocabulary \n (Word Activity Test Score)", "Cohort Member Vocabulary", "Cohort Member Vocabulary \n (Naming Vocabulary Score)", "R2 (%)")
                          


```


Create results table using flextable package - this can be exported straight into word. 

```{r}
#define border
my_border = border= fp_border(color="black", width=1)
results_Rq1Rq2 <- regression_resultsTable %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2:7, align="center", part="all") %>% 
  color(j=1:7, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2:7, width=1.4) %>% 
  line_spacing(j=2:7, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:7, part="all", border=my_border) %>% 
  hline_bottom(j=1:7,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable",model1_OR= "Model 1",
                    model2_OR= "Model 2",model3_OR = "Model 3", 
                    model1_b="Model 1", model2_b = "Model 2", model3_b = "Model 3") %>% 
 add_header_row(values = c(" ", "Binary Outcome (OR[95% CIs]", "Continuous Outcome (B[95% CIs]"), colwidths = c(1, 3, 3)) %>% 
  font(fontname = "Times New Roman", part="header") %>% 
  align(align="center", part="header") %>% 
  hline_top(j = 2:7, part = "all", border = my_border) %>% 
  bold(j = 1, i = c(1,47, 49), bold = TRUE) %>% 
  italic(j = 1, i = c(1,47, 49), italic = TRUE) 
  
  

 print(results_Rq1Rq2, preview = "docx") 

```




RQ3 - IS ANY RELATION MODERATED BY SEC? 

```{r}
#use composite SEC as the main moderator = run CFA to get composite factor score. 
#create dataset of each individual imputed data
imputed_mcs2_1 <- complete(imputed_mcs2,1)
imputed_mcs2_2 <- complete(imputed_mcs2,2)
imputed_mcs2_3 <- complete(imputed_mcs2,3)
imputed_mcs2_4 <- complete(imputed_mcs2,4)
imputed_mcs2_5 <- complete(imputed_mcs2,5)
imputed_mcs2_6 <- complete(imputed_mcs2,6)
imputed_mcs2_7 <- complete(imputed_mcs2,7)
imputed_mcs2_8 <- complete(imputed_mcs2,8)
imputed_mcs2_9 <- complete(imputed_mcs2,9)
imputed_mcs2_10 <- complete(imputed_mcs2,10)
imputed_mcs2_11 <- complete(imputed_mcs2,11)
imputed_mcs2_12 <- complete(imputed_mcs2,12)
imputed_mcs2_13 <- complete(imputed_mcs2,13)
imputed_mcs2_14 <- complete(imputed_mcs2,14)
imputed_mcs2_15 <- complete(imputed_mcs2,15)
imputed_mcs2_16 <- complete(imputed_mcs2,16)
imputed_mcs2_17 <- complete(imputed_mcs2,17)
imputed_mcs2_18 <- complete(imputed_mcs2,18)
imputed_mcs2_19 <- complete(imputed_mcs2,19)
imputed_mcs2_20<- complete(imputed_mcs2,20)
imputed_mcs2_21<- complete(imputed_mcs2,21)
imputed_mcs2_22<- complete(imputed_mcs2,22)
imputed_mcs2_23<- complete(imputed_mcs2,23)
imputed_mcs2_24<- complete(imputed_mcs2,24)
imputed_mcs2_25<- complete(imputed_mcs2,25)


#factor analysis to get factor score####
#factor analysis model


#create imputed datasets as a list - this is so can run CFA over each dataset
imputed_datasets = list(imputed_mcs2_1, imputed_mcs2_2, imputed_mcs2_3, imputed_mcs2_4, imputed_mcs2_5, 
                        imputed_mcs2_6, imputed_mcs2_7, imputed_mcs2_8, imputed_mcs2_9, imputed_mcs2_10, 
                        imputed_mcs2_11, imputed_mcs2_12, imputed_mcs2_13, imputed_mcs2_14, imputed_mcs2_15,
                        imputed_mcs2_16, imputed_mcs2_17, imputed_mcs2_18, imputed_mcs2_19, imputed_mcs2_20, 
                        imputed_mcs2_21, imputed_mcs2_22, imputed_mcs2_23, imputed_mcs2_24, imputed_mcs2_25)

#define CFA model to create SEP
SEP_model <- 'SEP =~ highest_nvq + oecd_income + wealth_quintiles + occupational_status + imd'

#run CFA across 25 imputed datasets
cfa_imputed = function(ert){
  fit = cfa(SEP_model, 
            data = ert,
            ordered = c("highest_nvq", "oecd_income","wealth_quintiles", "occupational_status", "imd"), 
            std.lv=TRUE, 
            estimator="WLSMV")
  ses_latent = lavPredict(fit, type = "lv")
}

#create and add SES latent variable to each dataset
imputed_datasets$ses_latent = lapply(imputed_datasets, cfa_imputed)

#get individual datasets from list - these will now have SEP composite (pull this out for each dataset). 
#this is so can run the regression over each dataset. 
imputed_data1 = imputed_datasets[[1]]
imputed_data1$ses_latent = imputed_datasets$ses_latent[[1]]
imputed_data2 = imputed_datasets[[2]]
imputed_data2$ses_latent = imputed_datasets$ses_latent[[2]]
imputed_data3 = imputed_datasets[[3]]
imputed_data3$ses_latent = imputed_datasets$ses_latent[[3]]
imputed_data4 = imputed_datasets[[4]]
imputed_data4$ses_latent = imputed_datasets$ses_latent[[4]]
imputed_data5 = imputed_datasets[[5]]
imputed_data5$ses_latent = imputed_datasets$ses_latent[[5]]
imputed_data6 = imputed_datasets[[6]]
imputed_data6$ses_latent = imputed_datasets$ses_latent[[6]]
imputed_data7 = imputed_datasets[[7]]
imputed_data7$ses_latent = imputed_datasets$ses_latent[[7]]
imputed_data8 = imputed_datasets[[8]]
imputed_data8$ses_latent = imputed_datasets$ses_latent[[8]]
imputed_data9 = imputed_datasets[[9]]
imputed_data9$ses_latent = imputed_datasets$ses_latent[[9]]
imputed_data10 = imputed_datasets[[10]]
imputed_data10$ses_latent = imputed_datasets$ses_latent[[10]]
imputed_data11 = imputed_datasets[[11]]
imputed_data11$ses_latent = imputed_datasets$ses_latent[[11]]
imputed_data12 = imputed_datasets[[12]]
imputed_data12$ses_latent = imputed_datasets$ses_latent[[12]]
imputed_datq13 = imputed_datasets[[13]]
imputed_data13$ses_latent = imputed_datasets$ses_latent[[13]]
imputed_data14 = imputed_datasets[[14]]
imputed_data14$ses_latent = imputed_datasets$ses_latent[[14]]
imputed_data15 = imputed_datasets[[15]]
imputed_data15$ses_latent = imputed_datasets$ses_latent[[15]]
imputed_data16 = imputed_datasets[[16]]
imputed_data16$ses_latent = imputed_datasets$ses_latent[[16]]
imputed_data17 = imputed_datasets[[17]]
imputed_data17$ses_latent = imputed_datasets$ses_latent[[17]]
imputed_data18 = imputed_datasets[[18]]
imputed_data18$ses_latent = imputed_datasets$ses_latent[[18]]
imputed_data19 = imputed_datasets[[19]]
imputed_data19$ses_latent = imputed_datasets$ses_latent[[19]]
imputed_data20 = imputed_datasets[[20]]
imputed_data20$ses_latent = imputed_datasets$ses_latent[[20]]
imputed_data21 = imputed_datasets[[21]]
imputed_data21$ses_latent = imputed_datasets$ses_latent[[21]]
imputed_data22 = imputed_datasets[[22]]
imputed_data22$ses_latent = imputed_datasets$ses_latent[[22]]
imputed_data23 = imputed_datasets[[23]]
imputed_data23$ses_latent = imputed_datasets$ses_latent[[23]]
imputed_data24 = imputed_datasets[[24]]
imputed_data24$ses_latent = imputed_datasets$ses_latent[[24]]
imputed_data25 = imputed_datasets[[25]]
imputed_data25$ses_latent = imputed_datasets$ses_latent[[25]]

#regression models with composite as the mdoerator. run this across 25 imputed datasets that have the ses_latent variable in. 

compositeModerator_model <- function(df) {
  fit <- glm(benchmark_binary ~ sex + ethnicity + EAL + country +
               + caregiver_vocabStandardised + ses_latent*age5_standardised, 
             family = binomial, weights = weight, data=df)
  return(fit)
}

#put new imputed datasets into lists (i.e. ones with the latent variable in them) and apply regression model to each
compositeModerator <- lapply(list(imputed_data1, imputed_data2, imputed_data3, imputed_data4, imputed_data5,
                                  imputed_data6, imputed_data7, imputed_data8, imputed_data9, imputed_data10,
                                  imputed_data11, imputed_data12, imputed_data13, imputed_data14, imputed_data15,
                                  imputed_data16, imputed_data17, imputed_data18, imputed_data19, imputed_data20,
                                  imputed_data21, imputed_data22, imputed_data23, imputed_data24, imputed_data25),
                             compositeModerator_model)
moderator_composite <- summary(pool(as.mira(compositeModerator)),conf.int = TRUE, conf.level = 0.95,  exponentiate = TRUE) 

#model without interaction term - for model comparison -will be run over 25 imputed datasets in the list
noCompositeModerator_model <- function(df) {
  fit1 <- glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                + caregiver_vocabStandardised + age5_standardised + ses_latent, 
              family = binomial, weights = weight, data=df)
  return(fit1)
}

#run regression across list of 25 imputed datasets that have latent variable in 
noCompositeModerator <- lapply(list(imputed_data1, imputed_data2, imputed_data3, imputed_data4, imputed_data5,
                                    imputed_data6, imputed_data7, imputed_data8, imputed_data9, imputed_data10,
                                    imputed_data11, imputed_data12, imputed_data13, imputed_data14, imputed_data15,
                                    imputed_data16, imputed_data17, imputed_data18, imputed_data19, imputed_data20,
                                    imputed_data21, imputed_data22, imputed_data23, imputed_data24, imputed_data25),
                               noCompositeModerator_model)

#convert into mira objects so that D1 function works to compare the nested models (mira - multiple imputation repeated analyses)
#The as.mira() function takes the results of repeated complete-data analysis stored as a list, and turns it into a mira object that can be pooled.
moderator = as.mira(compositeModerator)
noModerator = as.mira(noCompositeModerator)
#nested model comparison
D1(moderator, noModerator)
```

MODERATOR ANALYSIS ON EACH INDIVIDUAL SEC PREDICTOR

```{r}
#1. parent education as the moderator 
#vocabulary*NVQ interaction term
NVQ_moderator = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                                          oecd_income + occupational_status + wealth_quintiles + imd + 
                                         caregiver_vocabStandardised + highest_nvq*age5_standardised, 
                                         family = binomial, weights = weight))
#no interaction term
NVQ_noModerator = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                           oecd_income + occupational_status + wealth_quintiles + imd + 
                                           caregiver_vocabStandardised + highest_nvq + age5_standardised, 
                                         family = binomial, weights = weight))
#pooled results of models 
NVQ_moderatorResults = summary(pool(NVQ_moderator), conf.int = TRUE, exponentiate = TRUE)
NVQ_noModeratorResults = summary(pool(NVQ_noModerator), conf.int = TRUE, exponentiate = TRUE)
#compare model with moderator to model without moderator 
D1(NVQ_moderator, NVQ_noModerator)

#2. occupational status as the moderator 
#vocabulary*occupation interaction term
occupation_moderator = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                                highest_nvq+ oecd_income  + wealth_quintiles + imd + 
                                         caregiver_vocabStandardised + occupational_status*age5_standardised, 
                                       family = binomial, weights = weight))
#no interaction term
occupation_noModerator = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                           highest_nvq + oecd_income  + wealth_quintiles + imd + 
                                           caregiver_vocabStandardised + occupational_status + age5_standardised, 
                                         family = binomial, weights = weight))
#pooled results of models 
occupation_moderatorResults = summary(pool(occupation_moderator), conf.int = TRUE, exponentiate = TRUE)
occupation_noModeratorResults = summary(pool(occupation_noModerator), conf.int = TRUE, exponentiate = TRUE)
#compare model with moderator to model without moderator 
D1(occupation_moderator, occupation_noModerator)

#3. income as the moderator 
#vocabulary*income interaction term
income_moderator = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                                highest_nvq+ occupational_status  + wealth_quintiles + imd + 
                                                caregiver_vocabStandardised + oecd_income*age5_standardised, 
                                              family = binomial, weights = weight))
#no interaction term
income_noModerator = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                                  highest_nvq + occupational_status  + wealth_quintiles + imd + 
                                                  caregiver_vocabStandardised + oecd_income + age5_standardised, 
                                                family = binomial, weights = weight))
#pooled results of models 
income_moderatorResults = summary(pool(income_moderator), conf.int = TRUE, exponentiate = TRUE)
income_noModeratorResults = summary(pool(income_noModerator), conf.int = TRUE, exponentiate = TRUE)
#compare model with moderator to model without moderator 
D1(income_moderator, income_noModerator)

#4. wealth as the moderator 
#vocabulary*wealth interaction term
wealth_moderator = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                            highest_nvq+ oecd_income + occupational_status   + imd + 
                                            caregiver_vocabStandardised + wealth_quintiles*age5_standardised, 
                                          family = binomial, weights = weight))
#no interaction term
wealth_noModerator = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                              highest_nvq + oecd_income + occupational_status  + wealth_quintiles + imd + 
                                              caregiver_vocabStandardised + wealth_quintiles + age5_standardised, 
                                            family = binomial, weights = weight))
#pooled results of models 
wealth_moderatorResults = summary(pool(wealth_moderator), conf.int = TRUE, exponentiate = TRUE)
wealth_noModeratorResults = summary(pool(wealth_noModerator), conf.int = TRUE, exponentiate = TRUE)
#compare model with moderator to model without moderator 
D1(wealth_moderator, wealth_noModerator)

#5. imd as the moderator 
#vocabulary*wealth interaction term
imd_moderator = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                            highest_nvq+ oecd_income + occupational_status + wealth_quintiles + 
                                            caregiver_vocabStandardised + imd*age5_standardised, 
                                          family = binomial, weights = weight))
#no interaction term
imd_noModerator = with(imputed_mcs2, glm(benchmark_binary ~ sex + ethnicity + EAL + country +
                                              highest_nvq + oecd_income + occupational_status  + wealth_quintiles + 
                                              caregiver_vocabStandardised + imd + age5_standardised, 
                                            family = binomial, weights = weight))
#pooled results of models 
imd_moderatorResults = summary(pool(imd_moderator), conf.int = TRUE, exponentiate = TRUE)
imd_noModeratorResults = summary(pool(imd_noModerator), conf.int = TRUE, exponentiate = TRUE)
#compare model with moderator to model without moderator 
D1(imd_moderator, imd_noModerator)
```

results table for main moderator analysis (with SEC composite)

```{r}
#get relevant results for table - composite
moderator_composite$estimate = bv(moderator_composite$estimate) #no leading 0 
moderator_composite$`2.5 %` = bv(moderator_composite$`2.5 %`)
moderator_composite$`97.5 %` = bv(moderator_composite$`97.5 %`)
moderator_composite$p.value1= ifelse(moderator_composite$p.value< .001, "<.001" , pv1(moderator_composite$p.value))
moderator_composite$coefficient = paste0(moderator_composite$estimate, "[", moderator_composite$`2.5 %`, ";", moderator_composite$`97.5 %`, "]")
moderator_composite$stars = add.significance.stars(moderator_composite$p.value, cutoffs=c(0.05, 0.01, 0.001))
moderator_composite$p1 = paste0(moderator_composite$p.value1, "")
moderator_composite$p = paste0("p", moderator_composite$p1)
moderator_composite$new_coef = paste0(moderator_composite$coefficient, moderator_composite$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
moderator_composite1= moderator_composite%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
moderator_composite1$composite_secMod <- paste0(moderator_composite1$new_coef,"\n", moderator_composite1$p) 

moderator_composite1 = moderator_composite1 %>% select(term, composite_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) 
moderator_composite1 [is.na(moderator_composite1)] <- "REFERENCE"

#rename variables column 
moderator_composite1$term <- c("Sex (male)", "Sex (female)", 
                                  "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                                  "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                                  "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Caregiver Vocabulary \n (Word Activity Test Score)", "Socioeconomic Circumstances \n (composite) ", "Cohort Member Vocabulary \n (Naming Vocabulary Score)", "SEC*Vocabulary")

```


parent education as the moderator - results 
```{r}
#get relevant results for table - composite
NVQ_moderatorResults$estimate = bv(NVQ_moderatorResults$estimate) #no leading 0 
NVQ_moderatorResults$`2.5 %` = bv(NVQ_moderatorResults$`2.5 %`)
NVQ_moderatorResults$`97.5 %` = bv(NVQ_moderatorResults$`97.5 %`)
NVQ_moderatorResults$p.value1= ifelse(NVQ_moderatorResults$p.value< .001, "<.001" , pv1(NVQ_moderatorResults$p.value))
NVQ_moderatorResults$coefficient = paste0(NVQ_moderatorResults$estimate, "[", NVQ_moderatorResults$`2.5 %`, ";", NVQ_moderatorResults$`97.5 %`, "]")
NVQ_moderatorResults$stars = add.significance.stars(NVQ_moderatorResults$p.value, cutoffs=c(0.05, 0.01, 0.001))
NVQ_moderatorResults$p1 = paste0(NVQ_moderatorResults$p.value1, "")
NVQ_moderatorResults$p = paste0("p", NVQ_moderatorResults$p1)
NVQ_moderatorResults$new_coef = paste0(NVQ_moderatorResults$coefficient, NVQ_moderatorResults$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
NVQ_moderatorResults1= NVQ_moderatorResults%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
NVQ_moderatorResults1$nvq_secMod <- paste0(NVQ_moderatorResults1$new_coef,"\n", NVQ_moderatorResults1$p) 

NVQ_moderatorResults1 = NVQ_moderatorResults1 %>% select(term, nvq_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) %>% 
  add_row(term = "oecd_income1", .before= 16) %>% 
  add_row(term = "occupational_status2", .before = 21) %>% 
  add_row(term = "wealth_quintiles1", .before = 25) %>% 
  add_row(term = "imd1", .before = 30 ) %>% 
  add_row(term = "highest_nvq1", .before = 41) %>% 
  add_row(term = "highest_nvq1:age5_standardised*", .before =48)
NVQ_moderatorResults1 [is.na(NVQ_moderatorResults1)] <- "REFERENCE"

#rename variables column 
NVQ_moderatorResults1$term <- c("Sex (male)", "Sex (female)", 
                               "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                               "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                               "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Income Quintile 1", "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5", 
                               "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5", "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)",  
                               "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)",  "Caregiver Vocabulary \n (Word Activity Test Score)", 
                               "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)", "Cohort Member Vocabulary \n (Naming Vocabulary Score)", "Parent Education \n (NVQ1)*Age 5 Vocabulary", "Parent Education \n (None of these/overseas qualifications)*Age 5 Vocabulary", "Parent Education \n (NVQ2)*Age 5 Vocabulary", "Parent Education \n (NVQ3)*Age 5 Vocabulary", "Parent Education \n (NVQ4)*Age 5 Vocabulary", "Parent Education \n (NVQ5)*Age 5 Vocabulary")
```

occupational status as the moderator - results
```{r}
#get relevant results for table - composite
occupation_moderatorResults$estimate = bv(occupation_moderatorResults$estimate) #no leading 0 
occupation_moderatorResults$`2.5 %` = bv(occupation_moderatorResults$`2.5 %`)
occupation_moderatorResults$`97.5 %` = bv(occupation_moderatorResults$`97.5 %`)
occupation_moderatorResults$p.value1= ifelse(occupation_moderatorResults$p.value< .001, "<.001" , pv1(occupation_moderatorResults$p.value))
occupation_moderatorResults$coefficient = paste0(occupation_moderatorResults$estimate, "[", occupation_moderatorResults$`2.5 %`, ";", occupation_moderatorResults$`97.5 %`, "]")
occupation_moderatorResults$stars = add.significance.stars(occupation_moderatorResults$p.value, cutoffs=c(0.05, 0.01, 0.001))
occupation_moderatorResults$p1 = paste0(occupation_moderatorResults$p.value1, "")
occupation_moderatorResults$p = paste0("p", occupation_moderatorResults$p1)
occupation_moderatorResults$new_coef = paste0(occupation_moderatorResults$coefficient, occupation_moderatorResults$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
occupation_moderatorResults1= occupation_moderatorResults%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
occupation_moderatorResults1$occupation_secMod <- paste0(occupation_moderatorResults1$new_coef,"\n", occupation_moderatorResults1$p) 

occupation_moderatorResults1 = occupation_moderatorResults1 %>% select(term, occupation_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) %>% 
  add_row(term = "highest_nvq1", .before = 16) %>% 
  add_row(term = "oecd_income1", .before= 22) %>% 
  add_row(term = "wealth_quintiles1", .before = 27) %>% 
  add_row(term = "imd1", .before = 32) %>% 
  add_row(term = "occupational_status2", .before = 43) %>% 
  add_row(term = "occupational_status2:age5_standardised*", .before =48)
occupation_moderatorResults1 [is.na(occupation_moderatorResults1)] <- "REFERENCE"

#rename variables column 
occupation_moderatorResults1$term <- c("Sex (male)", "Sex (female)", 
                               "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                               "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                               "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)",
                               "Income Quintile 1", "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5", 
                               "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5",  
                               "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)",  "Caregiver Vocabulary \n (Word Activity Test Score)", "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)", "Cohort Member Vocabulary \n (Naming Vocabulary Score)", "Occupational Status \n (routine)*Age 5 Vocabulary", "Occupational Status \n (unemployed)*Age 5 Vocabulary", "Occupational Status \n (intermediate)*Age 5 Vocabulary", "Occupational Status \n (higher managerial)*Age 5 Vocabulary")
```

income moderator: results 
```{r}
#get relevant results for table - composite
income_moderatorResults$estimate = bv(income_moderatorResults$estimate) #no leading 0 
income_moderatorResults$`2.5 %` = bv(income_moderatorResults$`2.5 %`)
income_moderatorResults$`97.5 %` = bv(income_moderatorResults$`97.5 %`)
income_moderatorResults$p.value1= ifelse(income_moderatorResults$p.value< .001, "<.001" , pv1(income_moderatorResults$p.value))
income_moderatorResults$coefficient = paste0(income_moderatorResults$estimate, "[", income_moderatorResults$`2.5 %`, ";", income_moderatorResults$`97.5 %`, "]")
income_moderatorResults$stars = add.significance.stars(income_moderatorResults$p.value, cutoffs=c(0.05, 0.01, 0.001))
income_moderatorResults$p1 = paste0(income_moderatorResults$p.value1, "")
income_moderatorResults$p = paste0("p", income_moderatorResults$p1)
income_moderatorResults$new_coef = paste0(income_moderatorResults$coefficient, income_moderatorResults$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
income_moderatorResults1= income_moderatorResults%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
income_moderatorResults1$income_secMod <- paste0(income_moderatorResults1$new_coef,"\n", income_moderatorResults1$p) 

income_moderatorResults1 = income_moderatorResults1 %>% select(term, income_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) %>% 
  add_row(term = "highest_nvq1", .before = 16) %>% 
  add_row(term = "occupational_status2", .before= 22) %>% 
  add_row(term = "wealth_quintiles1", .before = 26) %>% 
  add_row(term = "imd1", .before = 31) %>% 
  add_row(term = "oecd_income1", .before = 42) %>% 
  add_row(term = "oecd_income1:age5_standardised", .before =48)
income_moderatorResults1 [is.na(income_moderatorResults1)] <- "REFERENCE"

#rename variables column 
income_moderatorResults1$term <- c("Sex (male)", "Sex (female)", 
                               "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                               "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                               "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)", "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)",
                               "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5",  
                               "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)",  "Caregiver Vocabulary \n (Word Activity Test Score)","Income Quintile 1", "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5",  "Cohort Member Vocabulary \n (Naming Vocabulary Score)", 
                               "Income Quintile 1*Age 5 Vocabulary", "Income Quintile 2*Age 5 Vocabulary", "Income Quintile 3*Age 5 Vocabulary", "Income Quintile 4*Age 5 Vocabulary", "Income Quintile 5*Age 5 Vocabulary")
```

wealth as moderator: results 
```{r}
#get relevant results for table - composite
wealth_moderatorResults$estimate = bv(wealth_moderatorResults$estimate) #no leading 0 
wealth_moderatorResults$`2.5 %` = bv(wealth_moderatorResults$`2.5 %`)
wealth_moderatorResults$`97.5 %` = bv(wealth_moderatorResults$`97.5 %`)
wealth_moderatorResults$p.value1= ifelse(wealth_moderatorResults$p.value< .001, "<.001" , pv1(wealth_moderatorResults$p.value))
wealth_moderatorResults$coefficient = paste0(wealth_moderatorResults$estimate, "[", wealth_moderatorResults$`2.5 %`, ";", wealth_moderatorResults$`97.5 %`, "]")
wealth_moderatorResults$stars = add.significance.stars(wealth_moderatorResults$p.value, cutoffs=c(0.05, 0.01, 0.001))
wealth_moderatorResults$p1 = paste0(wealth_moderatorResults$p.value1, "")
wealth_moderatorResults$p = paste0("p", wealth_moderatorResults$p1)
wealth_moderatorResults$new_coef = paste0(wealth_moderatorResults$coefficient, wealth_moderatorResults$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
wealth_moderatorResults1= wealth_moderatorResults%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
wealth_moderatorResults1$wealth_secMod <- paste0(wealth_moderatorResults1$new_coef,"\n", wealth_moderatorResults1$p) 

wealth_moderatorResults1 = wealth_moderatorResults1 %>% select(term, wealth_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) %>% 
  add_row(term = "highest_nvq1", .before = 16) %>% 
  add_row(term = "oecd_income1", .before = 22) %>% 
  add_row(term = "occupational_status2", .after= 26) %>% 
  add_row(term = "imd1", .before = 31) %>% 
  add_row(term = "wealth_quintiles1", .before = 42) %>% 
  add_row(term = "wealth_quintiles1:age5_standardised", .before =48)
wealth_moderatorResults1 [is.na(wealth_moderatorResults1)] <- "REFERENCE"

#rename variables column 
wealth_moderatorResults1$term <- c("Sex (male)", "Sex (female)", 
                               "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                               "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                               "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)", "Income Quintile 1",
                               "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5", 
                               "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)",
                               "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)",  "Caregiver Vocabulary \n (Word Activity Test Score)", "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5",  
 "Cohort Member Vocabulary \n (Naming Vocabulary Score)", 
                               "Wealth Quintile 1*Age 5 Vocabulary", "Wealth Quintile 2*Age 5 Vocabulary", "Wealth Quintile 3*Age 5 Vocabulary", "Wealth Quintile 4*Age 5 Vocabulary", "Wealth Quintile 5*Age 5 Vocabulary")
```

imd as moderator: results
```{r}
#get relevant results for table - composite
imd_moderatorResults$estimate = bv(imd_moderatorResults$estimate) #no leading 0 
imd_moderatorResults$`2.5 %` = bv(imd_moderatorResults$`2.5 %`)
imd_moderatorResults$`97.5 %` = bv(imd_moderatorResults$`97.5 %`)
imd_moderatorResults$p.value1= ifelse(imd_moderatorResults$p.value< .001, "<.001" , pv1(imd_moderatorResults$p.value))
imd_moderatorResults$coefficient = paste0(imd_moderatorResults$estimate, "[", imd_moderatorResults$`2.5 %`, ";", imd_moderatorResults$`97.5 %`, "]")
imd_moderatorResults$stars = add.significance.stars(imd_moderatorResults$p.value, cutoffs=c(0.05, 0.01, 0.001))
imd_moderatorResults$p1 = paste0(imd_moderatorResults$p.value1, "")
imd_moderatorResults$p = paste0("p", imd_moderatorResults$p1)
imd_moderatorResults$new_coef = paste0(imd_moderatorResults$coefficient, imd_moderatorResults$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
imd_moderatorResults1= imd_moderatorResults%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
imd_moderatorResults1$imd_secMod <- paste0(imd_moderatorResults1$new_coef,"\n", imd_moderatorResults1$p) 

imd_moderatorResults1 = imd_moderatorResults1 %>% select(term, imd_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) %>% 
  add_row(term = "highest_nvq1", .before = 16) %>% 
  add_row(term = "oecd_income1", .before = 22) %>% 
  add_row(term = "occupational_status2", .after= 26) %>% 
  add_row(term = "wealth_quintiles1", .before = 31) %>% 
  add_row(term = "imd1", .before = 37) %>% 
  add_row(term = "imd_quintiles1:age5_standardised", .before =48)
imd_moderatorResults1 [is.na(imd_moderatorResults1)] <- "REFERENCE"

#rename variables column 
imd_moderatorResults1$term <- c("Sex (male)", "Sex (female)", 
                               "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                               "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                               "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)", "Income Quintile 1",
                               "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5", 
                               "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)", "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5", 
                               "Caregiver Vocabulary \n (Word Activity Test Score)",   "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)", 
 "Cohort Member Vocabulary \n (Naming Vocabulary Score)", 
 "Relative Neighbourhood \n Deprivation \n (most deprived decile)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (10 - <20%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (20 - <30%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (30 - <40%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (40 - <50%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (50 - <60%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (60 - <70%)*Age 5 Vocabulary", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (80 - <90%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (least deprived decile)*Age 5 Vocabulary")
```

results table for composite moderator - created with flextable

```{r}
secModerator_table <- moderator_composite1 %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable",composite_secMod= "Composite SEC moderator \n (OR[95% CIs]") 

 print(secModerator_table, preview = "docx") 
  
```

results for NVQ moderator - made with flextable
```{r}
nvqModerator_table <- NVQ_moderatorResults1 %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable", nvq_secMod= "Parent education moderator \n (OR[95% CIs]") 
 print(nvqModerator_table, preview = "docx") 
```

results for occupation moderator - made with flextable
```{r}
occupationModerator_table <- occupation_moderatorResults1 %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable", occupation_secMod= "Occupational status moderator \n (OR[95% CIs]") 
 print(occupationModerator_table, preview = "docx") 
```

results for icnome moderator - made with flextable
```{r}
incomeModerator_table <- income_moderatorResults1 %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable", income_secMod= "Income moderator \n (OR[95% CIs]") 

 print(incomeModerator_table, preview = "docx") 
```

results for wealth moderator - made with flextable
```{r}
wealthModerator_table <- wealth_moderatorResults1 %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable", wealth_secMod= "Wealth moderator \n (OR[95% CIs]") 
 print(wealthModerator_table, preview = "docx") 
```

results for IMD moderator - made with flextable
```{r}
imdModerator_table <- imd_moderatorResults1 %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable", imd_secMod= "Relative neighbourhood deprivation moderator \n (OR[95% CIs]") 

 print(imdModerator_table, preview = "docx") 
```