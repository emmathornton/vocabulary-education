---
title: "R Notebook"
output:
  word_document: default
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r}
#load packages and data####
library(mice)
library(pander)
library(xtable)
library(dplyr)
library(gt)
library(glue)
library(tidyverse)
library(miceadds)
library(swfscMisc)
library(imputools)
library(haven)
library(sjmisc)
library(Hmisc)
library(psych)
library(lavaan)
library(ggplot2)
library(ggpubr)
library(officer)
library(flextable)
library(ftExtra)
library(ggeffects)
library(gtools)

#this will take a float (e.g. a p value) and return a string with 3 digits and no leading 0

bv <- function(val) {
  return(sub("^(-?)0.", "\\1.", sprintf("%.2f", val)))
}

#if the number is less than .001, it will give <.001. 
pv1 <- function(val) {
  return(paste("=", sub("^(-?)0.", "\\1.", sprintf("%.3f", val))))
}

#load("~/Documents/updated MCS datasets/education-datasetsDec22/2022-12-13_vocabulary_education_imputedMAIN/2022-12-13_vocabulary_education_imputedMAIN.Rdata")
load("~/Documents/updated MCS datasets/education-datasetsDec22/2023-01-20_vocabulary_education_imputedMAIN/2023-01-20_vocabulary_education_imputedMAIN.Rdata")
imputed_mcs2 = mi.res


```

RQ1 & 2 - DOES VOCAB PREDICT EDUCATIONAL ATTAINMENT?

1. Binary Outcome variable ####
1a. does vocabulary predict reaching a functional level in core subjects?
remember, having grade 4/c above in core subjects is the reference category.

```{r}
#binary outcome ####
#unadjusted relationship 

binary_unadjusted = with(imputed_mcs2, glm(success ~ standardised_age5_vocab,
                                        family = binomial,  weights = weight))

binary_unadjusted_results = round(summary(pool(binary_unadjusted), conf.int = TRUE, exponentiate = TRUE),2)

# adjusted relationship
binary_model1 = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + imd, 
                                       family = binomial, weights = weight))

binary_model2 = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + 
                                         imd + standardised_caregiver_vocab, 
                                       family = binomial, weights = weight))

binary_model3 = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + 
                                         imd + standardised_caregiver_vocab + standardised_age5_vocab, 
                                       family = binomial, weights = weight))

binary_model1Results = summary(pool(binary_model1), conf.int = TRUE, exponentiate = TRUE)
binary_model2Results = summary(pool(binary_model2), conf.int = TRUE, exponentiate = TRUE)
binary_model3Results = summary(pool(binary_model3), conf.int = TRUE, exponentiate = TRUE)
```

1b. does vocabulary predict reaching a functional level of education above and beyond SEC/caregiver vocab factors?
```{r}
#binary model comparisons####
#compare model with only sociodemographic factors to a model with caregiver vocab
#compare sociodemographics model to no predictors
#create null model 
null_binaryModel = with(imputed_mcs2, glm(success ~ 1,
                                        family = binomial,  weights = weight))
D1(binary_model1, null_binaryModel)
#model 2 compared to model 1
D1(binary_model2, binary_model1) 
#compare model with all confounders to model with vocab
D1(binary_model3, binary_model2) 
```

2. Continuous outcome variable####
2a does vocabulary predict level of achievement in core subjects regardless of pass/ fail? 

```{r}
#continuous outcome####
#unadjusted relationship

continuous_unadjusted = with(imputed_mcs2, lm(standardised_core_subjects ~ standardised_age5_vocab, weights = weight))

continuous_unadjusted_results = round(summary(pool(continuous_unadjusted), conf.int = TRUE),2)

#adjusted relationship 
continuous_model1 = with(imputed_mcs2, lm(standardised_core_subjects ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + imd, 
                                       weights = weight))

continuous_model2 = with(imputed_mcs2, lm(standardised_core_subjects ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + 
                                         imd + standardised_caregiver_vocab, 
                                        weights = weight))

continuous_model3 = with(imputed_mcs2, lm(standardised_core_subjects ~ sex + ethnicity + EAL + country +
                                         highest_nvq + oecd_income + occupational_status + wealth_quintiles + 
                                         imd + standardised_caregiver_vocab + standardised_age5_vocab, 
                                        weights = weight))

continuous_model1Results = summary(pool(continuous_model1), conf.int = TRUE)
continuous_model2Results = summary(pool(continuous_model2), conf.int = TRUE)
continuous_model3Results = summary(pool(continuous_model3), conf.int = TRUE)

round(pool.r.squared(continuous_unadjusted),4)*100
cont_model1R2 = as.data.frame(round(pool.r.squared(continuous_model1),4)*100)
cont_model2R2 = as.data.frame(round(pool.r.squared(continuous_model2),4)*100)
cont_model3R2 = as.data.frame(round(pool.r.squared(continuous_model3),4)*100)
```

2b. does vocabulary predict level of achievement in core subjects above and beyond SEC/caregiver vocab factors?

```{r}
#continuous model comparisons ####
#compare sociodemographics model to no predictors
#create null model 
null_continuousModel =  with(imputed_mcs2, lm(standardised_core_subjects ~ 1, weights = weight))
D1(continuous_model1, null_continuousModel)
#compare model with only sociodemographic factors to a model with caregiver vocab
D1(continuous_model2, continuous_model1) #check if need to use a specific method ?
#compare model with all confounders to model with vocab
D1(continuous_model3, continuous_model2) 
```

gather relevant information for table for RQ 1 & 2

```{r}
#RQ 1&2: tale preparation####
#model 1 for binary outcome
binary_model1Results$estimate = bv(binary_model1Results$estimate) #no leading 0 
binary_model1Results$`2.5 %` = bv(binary_model1Results$`2.5 %`)
binary_model1Results$`97.5 %` = bv(binary_model1Results$`97.5 %`)
binary_model1Results$p.value1= ifelse(binary_model1Results$p.value< .001, "<.001" , pv1(binary_model1Results$p.value))
binary_model1Results$coefficient = paste0(binary_model1Results$estimate, "[", binary_model1Results$`2.5 %`, ";", binary_model1Results$`97.5 %`, "]")
binary_model1Results$stars = add.significance.stars(binary_model1Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
binary_model1Results$p1 = paste0(binary_model1Results$p.value1, "")
binary_model1Results$p = paste0("p", binary_model1Results$p1)
binary_model1Results$new_coef = paste0(binary_model1Results$coefficient, binary_model1Results$stars)  #combine coefficients and stars into column.

#model 2 for binary outcome
binary_model2Results$estimate = bv(binary_model2Results$estimate) #no leading 0 
binary_model2Results$`2.5 %` = bv(binary_model2Results$`2.5 %`)
binary_model2Results$`97.5 %` = bv(binary_model2Results$`97.5 %`)
binary_model2Results$p.value1= ifelse(binary_model2Results$p.value< .001, "<.001" , pv1(binary_model2Results$p.value))
binary_model2Results$coefficient = paste0(binary_model2Results$estimate, "[", binary_model2Results$`2.5 %`, ";", binary_model2Results$`97.5 %`, "]")
binary_model2Results$stars = add.significance.stars(binary_model2Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
binary_model2Results$p1 = paste0(binary_model2Results$p.value1, "")
binary_model2Results$p = paste0("p", binary_model2Results$p1)
binary_model2Results$new_coef = paste0(binary_model2Results$coefficient, binary_model2Results$stars)  #combine coefficients and stars into column.

#model 3 for binary outcome
binary_model3Results$estimate = bv(binary_model3Results$estimate) #no leading 0 
binary_model3Results$`2.5 %` = bv(binary_model3Results$`2.5 %`)
binary_model3Results$`97.5 %` = bv(binary_model3Results$`97.5 %`)
binary_model3Results$p.value1= ifelse(binary_model3Results$p.value< .001, "<.001" , pv1(binary_model3Results$p.value))
binary_model3Results$coefficient = paste0(binary_model3Results$estimate, "[", binary_model3Results$`2.5 %`, ";", binary_model3Results$`97.5 %`, "]")
binary_model3Results$stars = add.significance.stars(binary_model3Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
binary_model3Results$p1 = paste0(binary_model3Results$p.value1, "")
binary_model3Results$p = paste0("p", binary_model3Results$p1)
binary_model3Results$new_coef = paste0(binary_model3Results$coefficient, binary_model3Results$stars)  #combine coefficients and stars into column.

#contunous outcome ####
#model 1 for continuous outcome
continuous_model1Results$estimate = bv(continuous_model1Results$estimate) #no leading 0 
continuous_model1Results$`2.5 %` = bv(continuous_model1Results$`2.5 %`)
continuous_model1Results$`97.5 %` = bv(continuous_model1Results$`97.5 %`)
continuous_model1Results$p.value1= ifelse(continuous_model1Results$p.value< .001, "<.001" , pv1(continuous_model1Results$p.value))
continuous_model1Results$coefficient = paste0(continuous_model1Results$estimate, "[", continuous_model1Results$`2.5 %`, ";", continuous_model1Results$`97.5 %`, "]")
continuous_model1Results$stars = add.significance.stars(continuous_model1Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
continuous_model1Results$p1 = paste0(continuous_model1Results$p.value1, "")
continuous_model1Results$p = paste0("p", continuous_model1Results$p1)
continuous_model1Results$new_coef = paste0(continuous_model1Results$coefficient, continuous_model1Results$stars)  #combine coefficients and stars into column.

#model 2 for continuous outcome
continuous_model2Results$estimate = bv(continuous_model2Results$estimate) #no leading 0 
continuous_model2Results$`2.5 %` = bv(continuous_model2Results$`2.5 %`)
continuous_model2Results$`97.5 %` = bv(continuous_model2Results$`97.5 %`)
continuous_model2Results$p.value1= ifelse(continuous_model2Results$p.value< .001, "<.001" , pv1(continuous_model2Results$p.value))
continuous_model2Results$coefficient = paste0(continuous_model2Results$estimate, "[", continuous_model2Results$`2.5 %`, ";", continuous_model2Results$`97.5 %`, "]")
continuous_model2Results$stars = add.significance.stars(continuous_model2Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
continuous_model2Results$p1 = paste0(continuous_model2Results$p.value1, "")
continuous_model2Results$p = paste0("p", continuous_model2Results$p1)
continuous_model2Results$new_coef = paste0(continuous_model2Results$coefficient, continuous_model2Results$stars)  #combine coefficients and stars into column.


#model 3 for continuous outcome
continuous_model3Results$estimate = bv(continuous_model3Results$estimate) #no leading 0 
continuous_model3Results$`2.5 %` = bv(continuous_model3Results$`2.5 %`)
continuous_model3Results$`97.5 %` = bv(continuous_model3Results$`97.5 %`)
continuous_model3Results$p.value1= ifelse(continuous_model3Results$p.value< .001, "<.001" , pv1(continuous_model3Results$p.value))
continuous_model3Results$coefficient = paste0(continuous_model3Results$estimate, "[", continuous_model3Results$`2.5 %`, ";", continuous_model3Results$`97.5 %`, "]")
continuous_model3Results$stars = add.significance.stars(continuous_model3Results$p.value, cutoffs=c(0.05, 0.01, 0.001))
continuous_model3Results$p1 = paste0(continuous_model3Results$p.value1, "")
continuous_model3Results$p = paste0("p", continuous_model3Results$p1)
continuous_model3Results$new_coef = paste0(continuous_model3Results$coefficient, continuous_model3Results$stars)  #combine coefficients and stars into column.


#get odds ratios and 95% CIs for table: logistic regression
binary_model1Results = binary_model1Results %>% select(term, new_coef, p)
binary_model2Results = binary_model2Results %>% select(term, new_coef, p)
binary_model3Results = binary_model3Results %>% select(term, new_coef, p)

binary_model1Results$model1_OR <- paste0(binary_model1Results$new_coef,"\n", binary_model1Results$p) 
binary_model2Results$model2_OR <- paste0(binary_model2Results$new_coef,"\n", binary_model2Results$p) 
binary_model3Results$model3_OR <- paste0(binary_model3Results$new_coef,"\n", binary_model3Results$p) 

binary_model1Results = binary_model1Results %>% select(term, model1_OR)
binary_model2Results = binary_model2Results %>% select(term, model2_OR)
binary_model3Results = binary_model3Results %>% select(term, model3_OR)

#add column to make it the same length for all 3 models - needs to be as long as model 3 
binary_model1Results = binary_model1Results %>% add_row(term = "standardised_caregiver_vocab") %>% 
  add_row(term = "standardised_age5_vocab")
binary_model2Results = binary_model2Results %>% add_row(term = "standardised_age5_vocab")

binary_outcomeResults = cbind(binary_model1Results, binary_model2Results, binary_model3Results)
binary_outcomeResults = binary_outcomeResults %>% select(!3 & !5)

binary_outcomeResults = binary_outcomeResults %>% add_row(term = "Sociodemographic confounders", .after = 1) %>% 
  add_row(term = "Caregiver vocabulary", .before = 39) %>% 
  add_row(term = "Cohort member vocabulary", .before  = 41) %>% 
  add_row(term = "R2", .after = 43)

#get coefficients and 95% CIs for table: linear regression
continuous_model1Results = continuous_model1Results %>% select(term, new_coef, p)
continuous_model2Results = continuous_model2Results %>% select(term, new_coef, p)
continuous_model3Results = continuous_model3Results %>% select(term, new_coef, p)

continuous_model1Results$model1_b <- paste0(continuous_model1Results$new_coef,"\n", continuous_model1Results$p) 
continuous_model2Results$model2_b <- paste0(continuous_model2Results$new_coef,"\n", continuous_model2Results$p) 
continuous_model3Results$model3_b <- paste0(continuous_model3Results$new_coef,"\n", continuous_model3Results$p) 

continuous_model1Results = continuous_model1Results %>% select(term, model1_b)
continuous_model2Results = continuous_model2Results %>% select(term, model2_b)
continuous_model3Results = continuous_model3Results %>% select(term, model3_b)


#add column to make it the same length for all 3 models - needs to be as long as model 3 
continuous_model1Results = continuous_model1Results %>% add_row(term = "standardised_caregiver_vocab") %>% 
  add_row(term = "standardised_age5_vocab") %>% 
  add_row(term = "R2", model1_b =paste0(cont_model1R2$est,"[", cont_model1R2$`lo 95`, ";", cont_model1R2$`hi 95`,"]"), .after = 39)
continuous_model2Results = continuous_model2Results %>% add_row(term = "standardised_age5_vocab") %>% 
  add_row(term = "R2", model2_b =paste0(cont_model2R2$est,"[", cont_model2R2$`lo 95`, ";", cont_model2R2$`hi 95`,"]"), .after = 39)
continuous_model3Results = continuous_model3Results %>% 
  add_row(term = "R2", model3_b =paste0(cont_model3R2$est,"[", cont_model3R2$`lo 95`, ";", cont_model3R2$`hi 95`,"]"), .after = 39)

continuous_outcomeResults = cbind(continuous_model1Results, continuous_model2Results, continuous_model3Results)
continuous_outcomeResults = continuous_outcomeResults %>% select(!3 & !5)

continuous_outcomeResults = continuous_outcomeResults %>% add_row(term = "Sociodemographic confounders", .after = 1) %>% 
  add_row(term = "Caregiver vocabulary", .before = 39) %>% 
  add_row(term = "Cohort member vocabulary", .before  = 41)


regression_resultsTable = cbind(binary_outcomeResults, continuous_outcomeResults)
regression_resultsTable [is.na(regression_resultsTable )] <- "  "
regression_resultsTable = regression_resultsTable %>% select(!5) %>%  
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .after = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .after = 3) %>% 
  add_row(term = "EAL1", .after = 9) %>% 
  add_row(term = "country1", .after =  12) %>% 
  add_row(term = "highest_nvq1", .after = 16) %>% 
  add_row(term = "oecd_income1", .after = 22) %>% 
  add_row(term = "occupational_status2", .after = 27) %>% 
  add_row(term = "wealth_quintiles1", .after = 31) %>% 
  add_row(term = "imd1", .after = 36 )
regression_resultsTable [is.na(regression_resultsTable )] <- "REFERENCE"
  
#rename variables column 

regression_resultsTable$term <- c("Sociodemographic confounders", "Sex (male)", "Sex (female)", 
                                  "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                                  "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                                  "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)",
                                  "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2)", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)", 
                           "Income Quintile 1", "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5", 
                           "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)",  
                           "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5",
                          "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)", "Caregiver Vocabulary", "Caregiver Vocabulary \n (Word Activity Test Score)", "Cohort Member Vocabulary", "Cohort Member Vocabulary \n (Naming Vocabulary Score)", "R2 (%)")
```


Create results table using flextable package - this can be exported straight into word. 

```{r}
#results with flextable####
#define border
my_border = border= fp_border(color="black", width=1)
results_Rq1Rq2 <- regression_resultsTable %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2:7, align="center", part="all") %>% 
  color(j=1:7, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2:7, width=1.4) %>% 
  line_spacing(j=2:7, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:7, part="all", border=my_border) %>% 
  hline_bottom(j=1:7,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable",model1_OR= "Model 1",
                    model2_OR= "Model 2",model3_OR = "Model 3", 
                    model1_b="Model 1", model2_b = "Model 2", model3_b = "Model 3") %>% 
 add_header_row(values = c(" ", "Binary Outcome (OR[95% CIs]", "Continuous Outcome (B[95% CIs]"), colwidths = c(1, 3, 3)) %>% 
  font(fontname = "Times New Roman", part="header") %>% 
  align(align="center", part="header") %>% 
  hline_top(j = 2:7, part = "all", border = my_border) %>% 
  bold(j = 1, i = c(1,47, 49), bold = TRUE) %>% 
  italic(j = 1, i = c(1,47, 49), italic = TRUE) %>% 
  add_header_lines(values = c("Table 3: Predicting Educational Attainment (≥grade 4 on core subjects and average grade) (N=15,576)"))
  
  

 print(results_Rq1Rq2, preview = "docx") 

```




RQ3 - IS ANY RELATION MODERATED BY SEC? 

```{r}
#use composite SEC as the main moderator = run CFA to get composite factor score. 
#create dataset of each individual imputed data
imputed_mcs2_1 <- complete(imputed_mcs2,1)
imputed_mcs2_2 <- complete(imputed_mcs2,2)
imputed_mcs2_3 <- complete(imputed_mcs2,3)
imputed_mcs2_4 <- complete(imputed_mcs2,4)
imputed_mcs2_5 <- complete(imputed_mcs2,5)
imputed_mcs2_6 <- complete(imputed_mcs2,6)
imputed_mcs2_7 <- complete(imputed_mcs2,7)
imputed_mcs2_8 <- complete(imputed_mcs2,8)
imputed_mcs2_9 <- complete(imputed_mcs2,9)
imputed_mcs2_10 <- complete(imputed_mcs2,10)
imputed_mcs2_11 <- complete(imputed_mcs2,11)
imputed_mcs2_12 <- complete(imputed_mcs2,12)
imputed_mcs2_13 <- complete(imputed_mcs2,13)
imputed_mcs2_14 <- complete(imputed_mcs2,14)
imputed_mcs2_15 <- complete(imputed_mcs2,15)
imputed_mcs2_16 <- complete(imputed_mcs2,16)
imputed_mcs2_17 <- complete(imputed_mcs2,17)
imputed_mcs2_18 <- complete(imputed_mcs2,18)
imputed_mcs2_19 <- complete(imputed_mcs2,19)
imputed_mcs2_20<- complete(imputed_mcs2,20)
imputed_mcs2_21<- complete(imputed_mcs2,21)
imputed_mcs2_22<- complete(imputed_mcs2,22)
imputed_mcs2_23<- complete(imputed_mcs2,23)
imputed_mcs2_24<- complete(imputed_mcs2,24)
imputed_mcs2_25<- complete(imputed_mcs2,25)


#factor analysis to get factor score####
#factor analysis model


#create imputed datasets as a list - this is so can run CFA over each dataset
imputed_datasets = list(imputed_mcs2_1, imputed_mcs2_2, imputed_mcs2_3, imputed_mcs2_4, imputed_mcs2_5, 
                        imputed_mcs2_6, imputed_mcs2_7, imputed_mcs2_8, imputed_mcs2_9, imputed_mcs2_10, 
                        imputed_mcs2_11, imputed_mcs2_12, imputed_mcs2_13, imputed_mcs2_14, imputed_mcs2_15,
                        imputed_mcs2_16, imputed_mcs2_17, imputed_mcs2_18, imputed_mcs2_19, imputed_mcs2_20, 
                        imputed_mcs2_21, imputed_mcs2_22, imputed_mcs2_23, imputed_mcs2_24, imputed_mcs2_25)

#define CFA model to create SEP
SEP_model <- 'SEP =~ highest_nvq + oecd_income + wealth_quintiles + occupational_status + imd'

#run CFA across 25 imputed datasets
cfa_imputed = function(ert){
  fit = cfa(SEP_model, 
            data = ert,
            ordered = c("highest_nvq", "oecd_income","wealth_quintiles", "occupational_status", "imd"), 
            std.lv=TRUE, 
            estimator="WLSMV")
  ses_latent = lavPredict(fit, type = "lv")
}

#create and add SES latent variable to each dataset
imputed_datasets$ses_latent = lapply(imputed_datasets, cfa_imputed)

#get individual datasets from list - these will now have SEP composite (pull this out for each dataset). 
#this is so can run the regression over each dataset. 
imputed_data1 = imputed_datasets[[1]]
imputed_data1$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[1]], center = TRUE, scale = TRUE))
#imputed_data1$ses_latent = scale(imputed_data1$ses_latent, center = TRUE, scale = TRUE)
imputed_data2 = imputed_datasets[[2]]
imputed_data2$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[2]], center = TRUE, scale = TRUE))
#imputed_data2$ses_latent = scale(imputed_data2$ses_latent, center = TRUE, scale = TRUE)
imputed_data3 = imputed_datasets[[3]]
imputed_data3$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[3]], center = TRUE, scale = TRUE))
#imputed_data3$ses_latent = scale(imputed_data3$ses_latent, center = TRUE, scale = TRUE)
imputed_data4 = imputed_datasets[[4]]
imputed_data4$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[4]], center = TRUE, scale = TRUE))
#imputed_data4$ses_latent = scale(imputed_data4$ses_latent, center = TRUE, scale = TRUE)
imputed_data5 = imputed_datasets[[5]]
imputed_data5$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[5]], center = TRUE, scale = TRUE))
#imputed_data5$ses_latent = scale(imputed_data5$ses_latent, center = TRUE, scale = TRUE)
imputed_data6 = imputed_datasets[[6]]
imputed_data6$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[6]], center = TRUE, scale = TRUE))
#imputed_data6$ses_latent = scale(imputed_data6$ses_latent, center = TRUE, scale = TRUE)
imputed_data7 = imputed_datasets[[7]]
imputed_data7$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[7]], center = TRUE, scale = TRUE))
#imputed_data7$ses_latent = scale(imputed_data7$ses_latent, center = TRUE, scale = TRUE)
imputed_data8 = imputed_datasets[[8]]
imputed_data8$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[8]], center = TRUE, scale = TRUE))
#imputed_data8$ses_latent = scale(imputed_data8$ses_latent, center = TRUE, scale = TRUE)
imputed_data9 = imputed_datasets[[9]]
imputed_data9$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[9]], center = TRUE, scale = TRUE))
#imputed_data9$ses_latent = scale(imputed_data9$ses_latent, center = TRUE, scale = TRUE)
imputed_data10 = imputed_datasets[[10]]
imputed_data10$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[10]], center = TRUE, scale = TRUE))
#imputed_data10$ses_latent = scale(imputed_data10$ses_latent, center = TRUE, scale = TRUE)
imputed_data11 = imputed_datasets[[11]]
imputed_data11$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[11]],center = TRUE, scale = TRUE))
#imputed_data11$ses_latent = scale(imputed_data11$ses_latent, center = TRUE, scale = TRUE)
imputed_data12 = imputed_datasets[[12]]
imputed_data12$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[12]], center = TRUE, scale = TRUE))
#imputed_data12$ses_latent = scale(imputed_data12$ses_latent, center = TRUE, scale = TRUE)
imputed_data13 = imputed_datasets[[13]]
imputed_data13$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[13]], center = TRUE, scale = TRUE))
#imputed_data13$ses_latent = scale(imputed_data13$ses_latent, center = TRUE, scale = TRUE)
imputed_data14 = imputed_datasets[[14]]
imputed_data14$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[14]], center = TRUE, scale = TRUE))
#imputed_data14$ses_latent = scale(imputed_data14$ses_latent, center = TRUE, scale = TRUE)
imputed_data15 = imputed_datasets[[15]]
imputed_data15$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[15]], center = TRUE, scale = TRUE))
#imputed_data15$ses_latent = scale(imputed_data15$ses_latent, center = TRUE, scale = TRUE)
imputed_data16 = imputed_datasets[[16]]
imputed_data16$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[16]], center = TRUE, scale = TRUE))
#imputed_data16$ses_latent = scale(imputed_data16$ses_latent, center = TRUE, scale = TRUE)
imputed_data17 = imputed_datasets[[17]]
imputed_data17$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[17]], center = TRUE, scale = TRUE))
#imputed_data17$ses_latent = scale(imputed_data17$ses_latent, center = TRUE, scale = TRUE)
imputed_data18 = imputed_datasets[[18]]
imputed_data18$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[18]], center = TRUE, scale = TRUE))
#imputed_data18$ses_latent = scale(imputed_data18$ses_latent, center = TRUE, scale = TRUE)
imputed_data19 = imputed_datasets[[19]]
imputed_data19$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[19]], center = TRUE, scale = TRUE))
#imputed_data19$ses_latent = scale(imputed_data19$ses_latent, center = TRUE, scale = TRUE)
imputed_data20 = imputed_datasets[[20]]
imputed_data20$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[20]], center = TRUE, scale = TRUE))
#imputed_data20$ses_latent = scale(imputed_data20$ses_latent, center = TRUE, scale = TRUE)
imputed_data21 = imputed_datasets[[21]]
imputed_data21$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[21]], center = TRUE, scale = TRUE))
#imputed_data21$ses_latent = scale(imputed_data21$ses_latent, center = TRUE, scale = TRUE)
imputed_data22 = imputed_datasets[[22]]
imputed_data22$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[22]], center = TRUE, scale = TRUE))
#imputed_data22$ses_latent = scale(imputed_data22$ses_latent, center = TRUE, scale = TRUE)
imputed_data23 = imputed_datasets[[23]]
imputed_data23$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[23]], center = TRUE, scale = TRUE))
#imputed_data23$ses_latent = scale(imputed_data23$ses_latent, center = TRUE, scale = TRUE)
imputed_data24 = imputed_datasets[[24]]
imputed_data24$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[24]], center = TRUE, scale = TRUE))
#imputed_data24$ses_latent = scale(imputed_data24$ses_latent, center = TRUE, scale = TRUE)
imputed_data25 = imputed_datasets[[25]]
imputed_data25$ses_latent = as.numeric(scale(imputed_datasets$ses_latent[[25]], center = TRUE, scale = TRUE))
#imputed_data25$ses_latent = scale(imputed_data25$ses_latent, center = TRUE, scale = TRUE)

#create composite SEC quintiles (these will be used for plotting later)
#add composite quintiles to data
#data 1
imputed_data1$composite_quintiles = quantcut(imputed_data1$ses_latent,5)
levels(imputed_data1$composite_quintiles)[1] = "1"
levels(imputed_data1$composite_quintiles)[2] = "2"
levels(imputed_data1$composite_quintiles)[3] = "3"
levels(imputed_data1$composite_quintiles)[4] = "4"
levels(imputed_data1$composite_quintiles)[5] = "5"
#data2
imputed_data2$composite_quintiles = quantcut(imputed_data2$ses_latent,5)
levels(imputed_data2$composite_quintiles)[1] = "1"
levels(imputed_data2$composite_quintiles)[2] = "2"
levels(imputed_data2$composite_quintiles)[3] = "3"
levels(imputed_data2$composite_quintiles)[4] = "4"
levels(imputed_data2$composite_quintiles)[5] = "5"
#data3
imputed_data3$composite_quintiles = quantcut(imputed_data3$ses_latent,5)
levels(imputed_data3$composite_quintiles)[1] = "1"
levels(imputed_data3$composite_quintiles)[2] = "2"
levels(imputed_data3$composite_quintiles)[3] = "3"
levels(imputed_data3$composite_quintiles)[4] = "4"
levels(imputed_data3$composite_quintiles)[5] = "5"
#dat4
imputed_data4$composite_quintiles = quantcut(imputed_data4$ses_latent,5)
levels(imputed_data4$composite_quintiles)[1] = "1"
levels(imputed_data4$composite_quintiles)[2] = "2"
levels(imputed_data4$composite_quintiles)[3] = "3"
levels(imputed_data4$composite_quintiles)[4] = "4"
levels(imputed_data4$composite_quintiles)[5] = "5"
#DATA5
imputed_data5$composite_quintiles = quantcut(imputed_data5$ses_latent,5)
levels(imputed_data5$composite_quintiles)[1] = "1"
levels(imputed_data5$composite_quintiles)[2] = "2"
levels(imputed_data5$composite_quintiles)[3] = "3"
levels(imputed_data5$composite_quintiles)[4] = "4"
levels(imputed_data5$composite_quintiles)[5] = "5"
#data6
imputed_data6$composite_quintiles = quantcut(imputed_data6$ses_latent,5)
levels(imputed_data6$composite_quintiles)[1] = "1"
levels(imputed_data6$composite_quintiles)[2] = "2"
levels(imputed_data6$composite_quintiles)[3] = "3"
levels(imputed_data6$composite_quintiles)[4] = "4"
levels(imputed_data6$composite_quintiles)[5] = "5"
#data7
imputed_data7$composite_quintiles = quantcut(imputed_data7$ses_latent,5)
levels(imputed_data7$composite_quintiles)[1] = "1"
levels(imputed_data7$composite_quintiles)[2] = "2"
levels(imputed_data7$composite_quintiles)[3] = "3"
levels(imputed_data7$composite_quintiles)[4] = "4"
levels(imputed_data7$composite_quintiles)[5] = "5"
#data 8
imputed_data8$composite_quintiles = quantcut(imputed_data8$ses_latent,5)
levels(imputed_data8$composite_quintiles)[1] = "1"
levels(imputed_data8$composite_quintiles)[2] = "2"
levels(imputed_data8$composite_quintiles)[3] = "3"
levels(imputed_data8$composite_quintiles)[4] = "4"
levels(imputed_data8$composite_quintiles)[5] = "5"
#data 9 
imputed_data9$composite_quintiles = quantcut(imputed_data9$ses_latent,5)
levels(imputed_data9$composite_quintiles)[1] = "1"
levels(imputed_data9$composite_quintiles)[2] = "2"
levels(imputed_data9$composite_quintiles)[3] = "3"
levels(imputed_data9$composite_quintiles)[4] = "4"
levels(imputed_data9$composite_quintiles)[5] = "5"
#data10
imputed_data10$composite_quintiles = quantcut(imputed_data10$ses_latent,5)
levels(imputed_data10$composite_quintiles)[1] = "1"
levels(imputed_data10$composite_quintiles)[2] = "2"
levels(imputed_data10$composite_quintiles)[3] = "3"
levels(imputed_data10$composite_quintiles)[4] = "4"
levels(imputed_data10$composite_quintiles)[5] = "5"
#data11
imputed_data11$composite_quintiles = quantcut(imputed_data11$ses_latent,5)
levels(imputed_data11$composite_quintiles)[1] = "1"
levels(imputed_data11$composite_quintiles)[2] = "2"
levels(imputed_data11$composite_quintiles)[3] = "3"
levels(imputed_data11$composite_quintiles)[4] = "4"
levels(imputed_data11$composite_quintiles)[5] = "5"
#data12
imputed_data12$composite_quintiles = quantcut(imputed_data12$ses_latent,5)
levels(imputed_data12$composite_quintiles)[1] = "1"
levels(imputed_data12$composite_quintiles)[2] = "2"
levels(imputed_data12$composite_quintiles)[3] = "3"
levels(imputed_data12$composite_quintiles)[4] = "4"
levels(imputed_data12$composite_quintiles)[5] = "5"
#data13
imputed_data13$composite_quintiles = quantcut(imputed_data13$ses_latent,5)
levels(imputed_data13$composite_quintiles)[1] = "1"
levels(imputed_data13$composite_quintiles)[2] = "2"
levels(imputed_data13$composite_quintiles)[3] = "3"
levels(imputed_data13$composite_quintiles)[4] = "4"
levels(imputed_data13$composite_quintiles)[5] = "5"
#data14
imputed_data14$composite_quintiles = quantcut(imputed_data14$ses_latent,5)
levels(imputed_data14$composite_quintiles)[1] = "1"
levels(imputed_data14$composite_quintiles)[2] = "2"
levels(imputed_data14$composite_quintiles)[3] = "3"
levels(imputed_data14$composite_quintiles)[4] = "4"
levels(imputed_data14$composite_quintiles)[5] = "5"
#data15
imputed_data15$composite_quintiles = quantcut(imputed_data15$ses_latent,5)
levels(imputed_data15$composite_quintiles)[1] = "1"
levels(imputed_data15$composite_quintiles)[2] = "2"
levels(imputed_data15$composite_quintiles)[3] = "3"
levels(imputed_data15$composite_quintiles)[4] = "4"
levels(imputed_data15$composite_quintiles)[5] = "5"
#data16
imputed_data16$composite_quintiles = quantcut(imputed_data16$ses_latent,5)
levels(imputed_data16$composite_quintiles)[1] = "1"
levels(imputed_data16$composite_quintiles)[2] = "2"
levels(imputed_data16$composite_quintiles)[3] = "3"
levels(imputed_data16$composite_quintiles)[4] = "4"
levels(imputed_data16$composite_quintiles)[5] = "5"
#data 17
imputed_data17$composite_quintiles = quantcut(imputed_data17$ses_latent,5)
levels(imputed_data17$composite_quintiles)[1] = "1"
levels(imputed_data17$composite_quintiles)[2] = "2"
levels(imputed_data17$composite_quintiles)[3] = "3"
levels(imputed_data17$composite_quintiles)[4] = "4"
levels(imputed_data17$composite_quintiles)[5] = "5"
#data18
imputed_data18$composite_quintiles = quantcut(imputed_data18$ses_latent,5)
levels(imputed_data18$composite_quintiles)[1] = "1"
levels(imputed_data18$composite_quintiles)[2] = "2"
levels(imputed_data18$composite_quintiles)[3] = "3"
levels(imputed_data18$composite_quintiles)[4] = "4"
levels(imputed_data18$composite_quintiles)[5] = "5"
#data 19
imputed_data19$composite_quintiles = quantcut(imputed_data19$ses_latent,5)
levels(imputed_data19$composite_quintiles)[1] = "1"
levels(imputed_data19$composite_quintiles)[2] = "2"
levels(imputed_data19$composite_quintiles)[3] = "3"
levels(imputed_data19$composite_quintiles)[4] = "4"
levels(imputed_data19$composite_quintiles)[5] = "5"
#data 20
imputed_data20$composite_quintiles = quantcut(imputed_data20$ses_latent,5)
levels(imputed_data20$composite_quintiles)[1] = "1"
levels(imputed_data20$composite_quintiles)[2] = "2"
levels(imputed_data20$composite_quintiles)[3] = "3"
levels(imputed_data20$composite_quintiles)[4] = "4"
levels(imputed_data20$composite_quintiles)[5] = "5"
#data 21
imputed_data21$composite_quintiles = quantcut(imputed_data21$ses_latent,5)
levels(imputed_data21$composite_quintiles)[1] = "1"
levels(imputed_data21$composite_quintiles)[2] = "2"
levels(imputed_data21$composite_quintiles)[3] = "3"
levels(imputed_data21$composite_quintiles)[4] = "4"
levels(imputed_data21$composite_quintiles)[5] = "5"
#data22
imputed_data22$composite_quintiles = quantcut(imputed_data22$ses_latent,5)
levels(imputed_data22$composite_quintiles)[1] = "1"
levels(imputed_data22$composite_quintiles)[2] = "2"
levels(imputed_data22$composite_quintiles)[3] = "3"
levels(imputed_data22$composite_quintiles)[4] = "4"
levels(imputed_data22$composite_quintiles)[5] = "5"
#data 23
imputed_data23$composite_quintiles = quantcut(imputed_data23$ses_latent,5)
levels(imputed_data23$composite_quintiles)[1] = "1"
levels(imputed_data23$composite_quintiles)[2] = "2"
levels(imputed_data23$composite_quintiles)[3] = "3"
levels(imputed_data23$composite_quintiles)[4] = "4"
levels(imputed_data23$composite_quintiles)[5] = "5"
#data 24
imputed_data24$composite_quintiles = quantcut(imputed_data24$ses_latent,5)
levels(imputed_data24$composite_quintiles)[1] = "1"
levels(imputed_data24$composite_quintiles)[2] = "2"
levels(imputed_data24$composite_quintiles)[3] = "3"
levels(imputed_data24$composite_quintiles)[4] = "4"
levels(imputed_data24$composite_quintiles)[5] = "5"
#data 25
imputed_data25$composite_quintiles = quantcut(imputed_data25$ses_latent,5)
levels(imputed_data25$composite_quintiles)[1] = "1"
levels(imputed_data25$composite_quintiles)[2] = "2"
levels(imputed_data25$composite_quintiles)[3] = "3"
levels(imputed_data25$composite_quintiles)[4] = "4"
levels(imputed_data25$composite_quintiles)[5] = "5"

#regression models with composite as the mdoerator. run this across 25 imputed datasets that have the ses_latent variable in. 

compositeModerator_model <- function(df) {
  fit <- glm(success ~ sex + ethnicity + EAL + country +
               + standardised_caregiver_vocab + ses_latent*standardised_age5_vocab, 
             family = binomial, weights = weight, data=df)
  return(fit)
}

#put new imputed datasets into lists (i.e. ones with the latent variable in them) and apply regression model to each
compositeModerator <- lapply(list(imputed_data1, imputed_data2, imputed_data3, imputed_data4, imputed_data5,
                                  imputed_data6, imputed_data7, imputed_data8, imputed_data9, imputed_data10,
                                  imputed_data11, imputed_data12, imputed_data13, imputed_data14, imputed_data15,
                                  imputed_data16, imputed_data17, imputed_data18, imputed_data19, imputed_data20,
                                  imputed_data21, imputed_data22, imputed_data23, imputed_data24, imputed_data25),
                             compositeModerator_model)
moderator_composite <- summary(pool(as.mira(compositeModerator)),conf.int = TRUE, conf.level = 0.95,  exponentiate = TRUE) 

#model without interaction term - for model comparison -will be run over 25 imputed datasets in the list
noCompositeModerator_model <- function(df) {
  fit1 <- glm(success ~ sex + ethnicity + EAL + country +
                + standardised_caregiver_vocab +  ses_latent + standardised_age5_vocab , 
              family = binomial, weights = weight, data=df)
  return(fit1)
}

#run regression across list of 25 imputed datasets that have latent variable in 
noCompositeModerator <- lapply(list(imputed_data1, imputed_data2, imputed_data3, imputed_data4, imputed_data5,
                                    imputed_data6, imputed_data7, imputed_data8, imputed_data9, imputed_data10,
                                    imputed_data11, imputed_data12, imputed_data13, imputed_data14, imputed_data15,
                                    imputed_data16, imputed_data17, imputed_data18, imputed_data19, imputed_data20,
                                    imputed_data21, imputed_data22, imputed_data23, imputed_data24, imputed_data25),
                               noCompositeModerator_model)

#convert into mira objects so that D1 function works to compare the nested models (mira - multiple imputation repeated analyses)
#The as.mira() function takes the results of repeated complete-data analysis stored as a list, and turns it into a mira object that can be pooled.
moderator = as.mira(compositeModerator)
noModerator = as.mira(noCompositeModerator)
#nested model comparison
D1(moderator, noModerator)
```

MODERATOR ANALYSIS ON EACH INDIVIDUAL SEC PREDICTOR

```{r}
#individual moderator indicators####
#1. parent education as the moderator 
#vocabulary*NVQ interaction term
NVQ_moderator = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                                          oecd_income + occupational_status + wealth_quintiles + imd + 
                                         standardised_caregiver_vocab + highest_nvq*standardised_age5_vocab, 
                                         family = binomial, weights = weight))
#no interaction term
NVQ_noModerator = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                           oecd_income + occupational_status + wealth_quintiles + imd + 
                                           standardised_caregiver_vocab + highest_nvq + standardised_age5_vocab, 
                                         family = binomial, weights = weight))
#pooled results of models 
NVQ_moderatorResults = summary(pool(NVQ_moderator), conf.int = TRUE, exponentiate = TRUE)
NVQ_noModeratorResults = summary(pool(NVQ_noModerator), conf.int = TRUE, exponentiate = TRUE)
#compare model with moderator to model without moderator 
D1(NVQ_moderator, NVQ_noModerator)

#2. occupational status as the moderator 
#vocabulary*occupation interaction term
occupation_moderator = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                                highest_nvq+ oecd_income  + wealth_quintiles + imd + 
                                         standardised_caregiver_vocab + occupational_status*standardised_age5_vocab, 
                                       family = binomial, weights = weight))
#no interaction term
occupation_noModerator = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                           highest_nvq + oecd_income  + wealth_quintiles + imd + 
                                           standardised_caregiver_vocab + occupational_status + standardised_age5_vocab, 
                                         family = binomial, weights = weight))
#pooled results of models 
occupation_moderatorResults = summary(pool(occupation_moderator), conf.int = TRUE, exponentiate = TRUE)
occupation_noModeratorResults = summary(pool(occupation_noModerator), conf.int = TRUE, exponentiate = TRUE)
#compare model with moderator to model without moderator 
D1(occupation_moderator, occupation_noModerator)

#3. income as the moderator 
#vocabulary*income interaction term
income_moderator = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                                highest_nvq+ occupational_status  + wealth_quintiles + imd + 
                                                standardised_caregiver_vocab + oecd_income*standardised_age5_vocab, 
                                              family = binomial, weights = weight))
#no interaction term
income_noModerator = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                                  highest_nvq + occupational_status  + wealth_quintiles + imd + 
                                                  standardised_caregiver_vocab + oecd_income + standardised_age5_vocab, 
                                                family = binomial, weights = weight))
#pooled results of models 
income_moderatorResults = summary(pool(income_moderator), conf.int = TRUE, exponentiate = TRUE)
income_noModeratorResults = summary(pool(income_noModerator), conf.int = TRUE, exponentiate = TRUE)
#compare model with moderator to model without moderator 
D1(income_moderator, income_noModerator)

#4. wealth as the moderator 
#vocabulary*wealth interaction term
wealth_moderator = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                            highest_nvq+ oecd_income + occupational_status   + imd + 
                                            standardised_caregiver_vocab + wealth_quintiles*standardised_age5_vocab, 
                                          family = binomial, weights = weight))
#no interaction term
wealth_noModerator = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                              highest_nvq + oecd_income + occupational_status  + wealth_quintiles + imd + 
                                              standardised_caregiver_vocab + wealth_quintiles + standardised_age5_vocab, 
                                            family = binomial, weights = weight))
#pooled results of models 
wealth_moderatorResults = summary(pool(wealth_moderator), conf.int = TRUE, exponentiate = TRUE)
wealth_noModeratorResults = summary(pool(wealth_noModerator), conf.int = TRUE, exponentiate = TRUE)
#compare model with moderator to model without moderator 
D1(wealth_moderator, wealth_noModerator)

#5. imd as the moderator 
#vocabulary*wealth interaction term
imd_moderator = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                            highest_nvq+ oecd_income + occupational_status + wealth_quintiles + 
                                            standardised_caregiver_vocab + imd*standardised_age5_vocab, 
                                          family = binomial, weights = weight))
#no interaction term
imd_noModerator = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                              highest_nvq + oecd_income + occupational_status  + wealth_quintiles + 
                                              standardised_caregiver_vocab + imd + standardised_age5_vocab, 
                                            family = binomial, weights = weight))
#pooled results of models 
imd_moderatorResults = summary(pool(imd_moderator), conf.int = TRUE, exponentiate = TRUE)
imd_noModeratorResults = summary(pool(imd_noModerator), conf.int = TRUE, exponentiate = TRUE)
#compare model with moderator to model without moderator 
D1(imd_moderator, imd_noModerator)
```

results table for main moderator analysis (with SEC composite)

```{r}
#get relevant results for table - composite#####
moderator_composite$estimate = bv(moderator_composite$estimate) #no leading 0 
moderator_composite$`2.5 %` = bv(moderator_composite$`2.5 %`)
moderator_composite$`97.5 %` = bv(moderator_composite$`97.5 %`)
moderator_composite$p.value1= ifelse(moderator_composite$p.value< .001, "<.001" , pv1(moderator_composite$p.value))
moderator_composite$coefficient = paste0(moderator_composite$estimate, "[", moderator_composite$`2.5 %`, ";", moderator_composite$`97.5 %`, "]")
moderator_composite$stars = add.significance.stars(moderator_composite$p.value, cutoffs=c(0.05, 0.01, 0.001))
moderator_composite$p1 = paste0(moderator_composite$p.value1, "")
moderator_composite$p = paste0("p", moderator_composite$p1)
moderator_composite$new_coef = paste0(moderator_composite$coefficient, moderator_composite$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
moderator_composite1= moderator_composite%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
moderator_composite1$composite_secMod <- paste0(moderator_composite1$new_coef,"\n", moderator_composite1$p) 

moderator_composite1 = moderator_composite1 %>% select(term, composite_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) 
moderator_composite1 [is.na(moderator_composite1)] <- "REFERENCE"

#rename variables column 
moderator_composite1$term <- c("Sex (male)", "Sex (female)", 
                                  "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                                  "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                                  "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Caregiver Vocabulary \n (Word Activity Test Score)", "Socioeconomic Circumstances \n (composite) ", "Cohort Member Vocabulary \n (Naming Vocabulary Score)", "SEC*Vocabulary")

```


parent education as the moderator - results 
```{r}
#parent education as the moderator - results ####
#get relevant results for table - composite
NVQ_moderatorResults$estimate = bv(NVQ_moderatorResults$estimate) #no leading 0 
NVQ_moderatorResults$`2.5 %` = bv(NVQ_moderatorResults$`2.5 %`)
NVQ_moderatorResults$`97.5 %` = bv(NVQ_moderatorResults$`97.5 %`)
NVQ_moderatorResults$p.value1= ifelse(NVQ_moderatorResults$p.value< .001, "<.001" , pv1(NVQ_moderatorResults$p.value))
NVQ_moderatorResults$coefficient = paste0(NVQ_moderatorResults$estimate, "[", NVQ_moderatorResults$`2.5 %`, ";", NVQ_moderatorResults$`97.5 %`, "]")
NVQ_moderatorResults$stars = add.significance.stars(NVQ_moderatorResults$p.value, cutoffs=c(0.05, 0.01, 0.001))
NVQ_moderatorResults$p1 = paste0(NVQ_moderatorResults$p.value1, "")
NVQ_moderatorResults$p = paste0("p", NVQ_moderatorResults$p1)
NVQ_moderatorResults$new_coef = paste0(NVQ_moderatorResults$coefficient, NVQ_moderatorResults$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
NVQ_moderatorResults1= NVQ_moderatorResults%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
NVQ_moderatorResults1$nvq_secMod <- paste0(NVQ_moderatorResults1$new_coef,"\n", NVQ_moderatorResults1$p) 

NVQ_moderatorResults1 = NVQ_moderatorResults1 %>% select(term, nvq_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) %>% 
  add_row(term = "oecd_income1", .before= 16) %>% 
  add_row(term = "occupational_status2", .before = 21) %>% 
  add_row(term = "wealth_quintiles1", .before = 25) %>% 
  add_row(term = "imd1", .before = 30 ) %>% 
  add_row(term = "highest_nvq1", .before = 41) %>% 
  add_row(term = "highest_nvq1:standardised_age5_vocab", .before =48)
NVQ_moderatorResults1 [is.na(NVQ_moderatorResults1)] <- "REFERENCE"

#rename variables column 
NVQ_moderatorResults1$term <- c("Sex (male)", "Sex (female)", 
                               "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                               "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                               "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Income Quintile 1", "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5", 
                               "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5", "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)",  
                               "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)",  "Caregiver Vocabulary \n (Word Activity Test Score)", 
                               "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2)", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)", "Cohort Member Vocabulary \n (Naming Vocabulary Score)", "Parent Education \n (NVQ1)*Age 5 Vocabulary", "Parent Education \n (None of these/overseas qualifications)*Age 5 Vocabulary", "Parent Education \n (NVQ2)*Age 5 Vocabulary", "Parent Education \n (NVQ3)*Age 5 Vocabulary", "Parent Education \n (NVQ4)*Age 5 Vocabulary", "Parent Education \n (NVQ5)*Age 5 Vocabulary")
```

occupational status as the moderator - results
```{r}
# occupation: get relevant results for table #####
occupation_moderatorResults$estimate = bv(occupation_moderatorResults$estimate) #no leading 0 
occupation_moderatorResults$`2.5 %` = bv(occupation_moderatorResults$`2.5 %`)
occupation_moderatorResults$`97.5 %` = bv(occupation_moderatorResults$`97.5 %`)
occupation_moderatorResults$p.value1= ifelse(occupation_moderatorResults$p.value< .001, "<.001" , pv1(occupation_moderatorResults$p.value))
occupation_moderatorResults$coefficient = paste0(occupation_moderatorResults$estimate, "[", occupation_moderatorResults$`2.5 %`, ";", occupation_moderatorResults$`97.5 %`, "]")
occupation_moderatorResults$stars = add.significance.stars(occupation_moderatorResults$p.value, cutoffs=c(0.05, 0.01, 0.001))
occupation_moderatorResults$p1 = paste0(occupation_moderatorResults$p.value1, "")
occupation_moderatorResults$p = paste0("p", occupation_moderatorResults$p1)
occupation_moderatorResults$new_coef = paste0(occupation_moderatorResults$coefficient, occupation_moderatorResults$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
occupation_moderatorResults1= occupation_moderatorResults%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
occupation_moderatorResults1$occupation_secMod <- paste0(occupation_moderatorResults1$new_coef,"\n", occupation_moderatorResults1$p) 

occupation_moderatorResults1 = occupation_moderatorResults1 %>% select(term, occupation_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) %>% 
  add_row(term = "highest_nvq1", .before = 16) %>% 
  add_row(term = "oecd_income1", .before= 22) %>% 
  add_row(term = "wealth_quintiles1", .before = 27) %>% 
  add_row(term = "imd1", .before = 32) %>% 
  add_row(term = "occupational_status2", .before = 43) %>% 
  add_row(term = "occupational_status2:standardised_age5_vocab*", .before =48)
occupation_moderatorResults1 [is.na(occupation_moderatorResults1)] <- "REFERENCE"

#rename variables column 
occupation_moderatorResults1$term <- c("Sex (male)", "Sex (female)", 
                               "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                               "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                               "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2)", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)",
                               "Income Quintile 1", "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5", 
                               "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5",  
                               "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)",  "Caregiver Vocabulary \n (Word Activity Test Score)", "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)", "Cohort Member Vocabulary \n (Naming Vocabulary Score)", "Occupational Status \n (routine)*Age 5 Vocabulary", "Occupational Status \n (unemployed)*Age 5 Vocabulary", "Occupational Status \n (intermediate)*Age 5 Vocabulary", "Occupational Status \n (higher managerial)*Age 5 Vocabulary")
```

income moderator: results 
```{r}
#income moderator: results ####
#get relevant results for table - composite
income_moderatorResults$estimate = bv(income_moderatorResults$estimate) #no leading 0 
income_moderatorResults$`2.5 %` = bv(income_moderatorResults$`2.5 %`)
income_moderatorResults$`97.5 %` = bv(income_moderatorResults$`97.5 %`)
income_moderatorResults$p.value1= ifelse(income_moderatorResults$p.value< .001, "<.001" , pv1(income_moderatorResults$p.value))
income_moderatorResults$coefficient = paste0(income_moderatorResults$estimate, "[", income_moderatorResults$`2.5 %`, ";", income_moderatorResults$`97.5 %`, "]")
income_moderatorResults$stars = add.significance.stars(income_moderatorResults$p.value, cutoffs=c(0.05, 0.01, 0.001))
income_moderatorResults$p1 = paste0(income_moderatorResults$p.value1, "")
income_moderatorResults$p = paste0("p", income_moderatorResults$p1)
income_moderatorResults$new_coef = paste0(income_moderatorResults$coefficient, income_moderatorResults$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
income_moderatorResults1= income_moderatorResults%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
income_moderatorResults1$income_secMod <- paste0(income_moderatorResults1$new_coef,"\n", income_moderatorResults1$p) 

income_moderatorResults1 = income_moderatorResults1 %>% select(term, income_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) %>% 
  add_row(term = "highest_nvq1", .before = 16) %>% 
  add_row(term = "occupational_status2", .before= 22) %>% 
  add_row(term = "wealth_quintiles1", .before = 26) %>% 
  add_row(term = "imd1", .before = 31) %>% 
  add_row(term = "oecd_income1", .before = 42) %>% 
  add_row(term = "oecd_income1:standardised_age5_vocab", .before =48)
income_moderatorResults1 [is.na(income_moderatorResults1)] <- "REFERENCE"

#rename variables column 
income_moderatorResults1$term <- c("Sex (male)", "Sex (female)", 
                               "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                               "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                               "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2)", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)", "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)",
                               "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5",  
                               "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)",  "Caregiver Vocabulary \n (Word Activity Test Score)","Income Quintile 1", "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5",  "Cohort Member Vocabulary \n (Naming Vocabulary Score)", 
                               "Income Quintile 1*Age 5 Vocabulary", "Income Quintile 2*Age 5 Vocabulary", "Income Quintile 3*Age 5 Vocabulary", "Income Quintile 4*Age 5 Vocabulary", "Income Quintile 5*Age 5 Vocabulary")
```

wealth as moderator: results 
```{r}
#wealth as moderator: results ####
#get relevant results for table - composite
wealth_moderatorResults$estimate = bv(wealth_moderatorResults$estimate) #no leading 0 
wealth_moderatorResults$`2.5 %` = bv(wealth_moderatorResults$`2.5 %`)
wealth_moderatorResults$`97.5 %` = bv(wealth_moderatorResults$`97.5 %`)
wealth_moderatorResults$p.value1= ifelse(wealth_moderatorResults$p.value< .001, "<.001" , pv1(wealth_moderatorResults$p.value))
wealth_moderatorResults$coefficient = paste0(wealth_moderatorResults$estimate, "[", wealth_moderatorResults$`2.5 %`, ";", wealth_moderatorResults$`97.5 %`, "]")
wealth_moderatorResults$stars = add.significance.stars(wealth_moderatorResults$p.value, cutoffs=c(0.05, 0.01, 0.001))
wealth_moderatorResults$p1 = paste0(wealth_moderatorResults$p.value1, "")
wealth_moderatorResults$p = paste0("p", wealth_moderatorResults$p1)
wealth_moderatorResults$new_coef = paste0(wealth_moderatorResults$coefficient, wealth_moderatorResults$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
wealth_moderatorResults1= wealth_moderatorResults%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
wealth_moderatorResults1$wealth_secMod <- paste0(wealth_moderatorResults1$new_coef,"\n", wealth_moderatorResults1$p) 

wealth_moderatorResults1 = wealth_moderatorResults1 %>% select(term, wealth_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) %>% 
  add_row(term = "highest_nvq1", .before = 16) %>% 
  add_row(term = "oecd_income1", .before = 22) %>% 
  add_row(term = "occupational_status2", .after= 26) %>% 
  add_row(term = "imd1", .before = 31) %>% 
  add_row(term = "wealth_quintiles1", .before = 42) %>% 
  add_row(term = "wealth_quintiles1:standardised_age5_vocab", .before =48)
wealth_moderatorResults1 [is.na(wealth_moderatorResults1)] <- "REFERENCE"

#rename variables column 
wealth_moderatorResults1$term <- c("Sex (male)", "Sex (female)", 
                               "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                               "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                               "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2)", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)", "Income Quintile 1",
                               "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5", 
                               "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)",
                               "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)",  "Caregiver Vocabulary \n (Word Activity Test Score)", "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5",  
 "Cohort Member Vocabulary \n (Naming Vocabulary Score)", 
                               "Wealth Quintile 1*Age 5 Vocabulary", "Wealth Quintile 2*Age 5 Vocabulary", "Wealth Quintile 3*Age 5 Vocabulary", "Wealth Quintile 4*Age 5 Vocabulary", "Wealth Quintile 5*Age 5 Vocabulary")
```

imd as moderator: results
```{r}
#imd as moderator: results####
#get relevant results for table - composite
imd_moderatorResults$estimate = bv(imd_moderatorResults$estimate) #no leading 0 
imd_moderatorResults$`2.5 %` = bv(imd_moderatorResults$`2.5 %`)
imd_moderatorResults$`97.5 %` = bv(imd_moderatorResults$`97.5 %`)
imd_moderatorResults$p.value1= ifelse(imd_moderatorResults$p.value< .001, "<.001" , pv1(imd_moderatorResults$p.value))
imd_moderatorResults$coefficient = paste0(imd_moderatorResults$estimate, "[", imd_moderatorResults$`2.5 %`, ";", imd_moderatorResults$`97.5 %`, "]")
imd_moderatorResults$stars = add.significance.stars(imd_moderatorResults$p.value, cutoffs=c(0.05, 0.01, 0.001))
imd_moderatorResults$p1 = paste0(imd_moderatorResults$p.value1, "")
imd_moderatorResults$p = paste0("p", imd_moderatorResults$p1)
imd_moderatorResults$new_coef = paste0(imd_moderatorResults$coefficient, imd_moderatorResults$stars)  #combine coefficients and stars into column.

#select just odds ratio and p values
imd_moderatorResults1= imd_moderatorResults%>% select(term, new_coef, p)
#put p value into same cell as ratio for table
imd_moderatorResults1$imd_secMod <- paste0(imd_moderatorResults1$new_coef,"\n", imd_moderatorResults1$p) 

imd_moderatorResults1 = imd_moderatorResults1 %>% select(term, imd_secMod) %>% 
  slice(-(1)) %>% #remove intercept row
  add_row(term = "sex1", .before  = 1) %>% #add in reference categories for factor variables
  add_row(term = "ethnicity1", .before= 3) %>% 
  add_row(term = "EAL1", .before = 9) %>% 
  add_row(term = "country1", .before =  12) %>% 
  add_row(term = "highest_nvq1", .before = 16) %>% 
  add_row(term = "oecd_income1", .before = 22) %>% 
  add_row(term = "occupational_status2", .after= 26) %>% 
  add_row(term = "wealth_quintiles1", .before = 31) %>% 
  add_row(term = "imd1", .before = 37) %>% 
  add_row(term = "imd_quintiles1:standardised_age5_vocab", .before =48)
imd_moderatorResults1 [is.na(imd_moderatorResults1)] <- "REFERENCE"

#rename variables column 
imd_moderatorResults1$term <- c("Sex (male)", "Sex (female)", 
                               "Ethnicity \n (White)", "Ethnicity \n (mixed)", "Ethnicity \n (Indian)", "Ethnicity \n (Pakistani & Bangladeshi)", "Ethnicity \n (Black/ Black British)", "Ethnicity \n (other incl. Chinese)", 
                               "EAL \n (English only)", "EAL \n (English and another language)", "EAL \n (only another language)", 
                               "Country \n (England)", "Country \n (Wales)", "Country \n (Scotland)", "Country \n (Northern Ireland)", "Parent Education \n (NVQ1)", "Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2)", "Parent Education \n (NVQ3)", "Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)", "Income Quintile 1",
                               "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5", 
                               "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)", "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5", 
                               "Caregiver Vocabulary \n (Word Activity Test Score)",   "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)", 
 "Cohort Member Vocabulary \n (Naming Vocabulary Score)", 
 "Relative Neighbourhood \n Deprivation \n (most deprived decile)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (10 - <20%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (20 - <30%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (30 - <40%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (40 - <50%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (50 - <60%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (60 - <70%)*Age 5 Vocabulary", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (80 - <90%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (least deprived decile)*Age 5 Vocabulary")
```

results table for composite moderator - created with flextable

```{r}
#composite moderator table####
secModerator_table <- moderator_composite1 %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable",composite_secMod= "Composite SEC moderator \n (OR[95% CIs]") 

 print(secModerator_table, preview = "docx") 
  
```

results for NVQ moderator - made with flextable
```{r}
#nvq moderator table####
nvqModerator_table <- NVQ_moderatorResults1 %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable", nvq_secMod= "Parent education moderator \n (OR[95% CIs]") 
 print(nvqModerator_table, preview = "docx") 
```

results for occupation moderator - made with flextable
```{r}
#occupation moderator table####
occupationModerator_table <- occupation_moderatorResults1 %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable", occupation_secMod= "Occupational status moderator \n (OR[95% CIs]") 
 print(occupationModerator_table, preview = "docx") 
```

results for icnome moderator - made with flextable
```{r}
#income moderator table####
incomeModerator_table <- income_moderatorResults1 %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable", income_secMod= "Income moderator \n (OR[95% CIs]") 

 print(incomeModerator_table, preview = "docx") 
```

results for wealth moderator - made with flextable
```{r}
#wealth moderator table####
wealthModerator_table <- wealth_moderatorResults1 %>% 
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable", wealth_secMod= "Wealth moderator \n (OR[95% CIs]") 
 print(wealthModerator_table, preview = "docx") 
```

results for IMD moderator - made with flextable
```{r}
#imd moderator table####
imdModerator_table <- imd_moderatorResults1 %>%
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2, align="center", part="all") %>% 
  color(j=1:2, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2, width=1.4) %>% 
  line_spacing(j=2, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:2, part="all", border=my_border) %>% 
  hline_bottom(j=1:2,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable", imd_secMod= "Relative neighbourhood deprivation moderator \n (OR[95% CIs]") 

 print(imdModerator_table, preview = "docx") 
```

try and put moderator results all into one table? 
```{r}
#moderator results all in one table####
moderator_results = full_join(moderator_composite1,NVQ_moderatorResults1, keep = TRUE, by = "term") %>% 
  mutate(term = case_when(!is.na(term.x)~term.x, 
                              is.na(term.x)~term.y)) %>% 
  select(term, composite_secMod, nvq_secMod) %>% 
  full_join(income_moderatorResults1, keep = TRUE) %>% 
  mutate(term = case_when(!is.na(term.x)~term.x, 
                          is.na(term.x)~term.y)) %>% 
  select(term, composite_secMod, nvq_secMod, income_secMod) %>% 
  full_join(occupation_moderatorResults1, keep =TRUE) %>% 
  mutate(term = case_when(!is.na(term.x)~term.x, 
                          is.na(term.x)~term.y)) %>% 
  select(term, composite_secMod, nvq_secMod, income_secMod, occupation_secMod) %>% 
  full_join(wealth_moderatorResults1, keep =TRUE) %>% 
  mutate(term = case_when(!is.na(term.x)~term.x, 
                          is.na(term.x)~term.y)) %>% 
  select(term, composite_secMod, nvq_secMod, income_secMod, occupation_secMod, wealth_secMod) %>%
  full_join(imd_moderatorResults1, keep =TRUE) %>% 
  mutate(term = case_when(!is.na(term.x)~term.x, 
                          is.na(term.x)~term.y)) %>% 
  select(term, composite_secMod, nvq_secMod, income_secMod, occupation_secMod, wealth_secMod, imd_secMod) 
```

put into flextable
```{r}
#moderator analyses results with confounds####
moderator_table <- moderator_results %>%
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2:7, align="center", part="all") %>% 
  color(j=1:7, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2:7, width=1.4) %>% 
  line_spacing(j=2:7, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:7, part="all", border=my_border) %>% 
  hline_bottom(j=1:7,part="body",  border=my_border) %>% 
  set_header_labels(term= "Variable", composite_secMod= "Composite SEC moderator \n (OR[95% CIs]", 
                    nvq_secMod= "Parent education moderator \n (OR[95% CIs]",
                    income_secMod= "Income moderator \n (OR[95% CIs]",
                    occupation_secMod= "Occupational status moderator \n (OR[95% CIs]",
                    wealth_secMod= "Wealth moderator \n (OR[95% CIs]",
                    imd_secMod= "Relative neighbourhood deprivation moderator \n (OR[95% CIs]") 
 print(moderator_table, preview = "docx") 
```

or, could have this table so that it is just the main effects and interaction terms, and not the confounding variables? so would be SEC composite, language, parent education, income, occupation, wealth, imd?
```{r}
#main effects and interaction terms table####
moderator_composite2 = moderator_composite1[17:19,]
moderator_composite2 = moderator_composite2 %>% select(term, composite_secMod)
NVQ_moderatorResults2 = NVQ_moderatorResults1 [41:53,]
NVQ_moderatorResults2  = NVQ_moderatorResults2  %>% select(term, nvq_secMod)
income_moderatorResults2 = income_moderatorResults1[42:52,]
income_moderatorResults2  = income_moderatorResults2  %>% select(term, income_secMod)
occupation_moderatorResults2 = occupation_moderatorResults1[43:51,]
occupation_moderatorResults2  = occupation_moderatorResults2  %>% select(term, occupation_secMod)
wealth_moderatorResults2 = wealth_moderatorResults1[42:52,]
wealth_moderatorResults2  = wealth_moderatorResults2  %>% select(term, wealth_secMod)
imd_moderatorResults2 = imd_moderatorResults1[37:57,]
imd_moderatorResults2  = imd_moderatorResults2  %>% select(term, imd_secMod)

moderator_results2 = full_join(moderator_composite2,NVQ_moderatorResults2, keep = TRUE, by = "term") %>% 
  mutate(term = case_when(!is.na(term.x)~term.x, 
                              is.na(term.x)~term.y)) %>% 
  select(term, composite_secMod, nvq_secMod) %>% 
  full_join(income_moderatorResults2, keep = TRUE) %>% 
  mutate(term = case_when(!is.na(term.x)~term.x, 
                          is.na(term.x)~term.y)) %>% 
  select(term, composite_secMod, nvq_secMod, income_secMod) %>% 
  full_join(occupation_moderatorResults2, keep =TRUE) %>% 
  mutate(term = case_when(!is.na(term.x)~term.x, 
                          is.na(term.x)~term.y)) %>% 
  select(term, composite_secMod, nvq_secMod, income_secMod, occupation_secMod) %>% 
  full_join(wealth_moderatorResults2, keep =TRUE) %>% 
  mutate(term = case_when(!is.na(term.x)~term.x, 
                          is.na(term.x)~term.y)) %>% 
  select(term, composite_secMod, nvq_secMod, income_secMod, occupation_secMod, wealth_secMod) %>%
  full_join(imd_moderatorResults2, keep =TRUE) %>% 
  mutate(term = case_when(!is.na(term.x)~term.x, 
                          is.na(term.x)~term.y)) %>% 
  select(term, composite_secMod, nvq_secMod, income_secMod, occupation_secMod, wealth_secMod, imd_secMod) 

#reorder variables so that vocabulary at the top, and then each SEC main effect and interction term diagonally across
#custom reorder of variables - create vector with order of variable names want. these need to exactly match variable names in dataframe
variables = c("Cohort Member Vocabulary \n (Naming Vocabulary Score)", 	"Socioeconomic Circumstances \n (composite) ", "SEC*Vocabulary",
              "Parent Education \n (NVQ1)","Parent Education \n (None of these/overseas qualifications)", "Parent Education \n (NVQ2)",  "Parent Education \n (NVQ3)","Parent Education \n (NVQ4)", "Parent Education \n (NVQ5)","Parent Education \n (NVQ1)*Age 5 Vocabulary","Parent Education \n (None of these/overseas qualifications)*Age 5 Vocabulary","Parent Education \n (NVQ2)*Age 5 Vocabulary", "Parent Education \n (NVQ3)*Age 5 Vocabulary", "Parent Education \n (NVQ4)*Age 5 Vocabulary", "Parent Education \n (NVQ5)*Age 5 Vocabulary",
              "Income Quintile 1", "Income Quintile 2", "Income Quintile 3", "Income Quintile 4", "Income Quintile 5",  
              "Income Quintile 1*Age 5 Vocabulary", "Income Quintile 2*Age 5 Vocabulary", "Income Quintile 3*Age 5 Vocabulary", "Income Quintile 4*Age 5 Vocabulary", "Income Quintile 5*Age 5 Vocabulary",
              "Occupational Status \n (routine)", "Occupational Status \n (unemployed)", "Occupational Status \n (intermediate)", "Occupational Status \n (higher managerial)", "Occupational Status \n (routine)*Age 5 Vocabulary", "Occupational Status \n (unemployed)*Age 5 Vocabulary", "Occupational Status \n (intermediate)*Age 5 Vocabulary", "Occupational Status \n (higher managerial)*Age 5 Vocabulary", 
              "Wealth Quintile 1", "Wealth Quintile 2", "Wealth Quintile 3", "Wealth Quintile 4", "Wealth Quintile 5",  
              "Wealth Quintile 1*Age 5 Vocabulary", "Wealth Quintile 2*Age 5 Vocabulary", "Wealth Quintile 3*Age 5 Vocabulary", "Wealth Quintile 4*Age 5 Vocabulary", "Wealth Quintile 5*Age 5 Vocabulary", 
              "Relative Neighbourhood \n Deprivation \n (most deprived decile)", "Relative Neighbourhood \n Deprivation \n (10 - <20%)", "Relative Neighbourhood \n Deprivation \n (20 - <30%)", "Relative Neighbourhood \n Deprivation \n (30 - <40%)", "Relative Neighbourhood \n Deprivation \n (40 - <50%)", "Relative Neighbourhood \n Deprivation \n (50 - <60%)", "Relative Neighbourhood \n Deprivation \n (60 - <70%)", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)", "Relative Neighbourhood \n Deprivation \n (80 - <90%)", "Relative Neighbourhood \n Deprivation \n (least deprived decile)", "Relative Neighbourhood \n Deprivation \n (most deprived decile)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (10 - <20%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (20 - <30%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (30 - <40%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (40 - <50%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (50 - <60%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (60 - <70%)*Age 5 Vocabulary", "Relative Neighbourhood \n  Deprivation \n (70 - <80%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (80 - <90%)*Age 5 Vocabulary", "Relative Neighbourhood \n Deprivation \n (least deprived decile)*Age 5 Vocabulary")

#reorder data according to custom matrix
moderator_results3 = moderator_results2 %>% slice(match(variables, term))

#add indicator labels for vertical column in table. space for most of these as will merge cells later. 
moderator_results3 = moderator_results3 %>%  add_column(z= c(" ", "SEC Composite Moderator"," ", 
                                                              "Parent Education Moderator", "  ", "  ", "  ", "  ", "  ", "  ", 
                                                              "  ", "  ", "  ", "  ", "  ",
                                                     "Income Moderator", "  ", "  ", "  ", "  ",  "  ", "  ", "  ", "  ","  ", 
                                                     "Occupational Status Moderator",  "  ", "  ", "  ", "  ",  "  ", "  ", "  ", 
                                                     "Wealth Moderator",  "  ", "  ", "  ","  ", "  ", "  ","  ","  ", "  ",
                                                     "Neighbourhood Deprivation Moderator",  "  ", "  ", "  ", "  ",  "  ", "  ", "  ", "  ",  "  ", "  ", "  ", "  ", "  ",  "  ", "  ", "  ", "  ",  "  ", "  "),.before = 1)

```

create table with flextable
```{r}
#moderator table with all moderators in same table####
moderator_table2 <- moderator_results3 %>%
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% #
  fontsize(size=10, part = "all") %>% #
  align(j=1, align="left", part="all") %>% 
  align(j=2:8, align="center", part="all") %>% 
  color(j=1:8, color="black", part="all") %>% 
  width(j=1, width=1) %>% 
  width(j=2:8, width=1.4) %>% 
  line_spacing(j=2:8, space=1.5) %>% 
  line_spacing(j=1, space=1.5) %>% 
  border_remove() %>% 
  hline_top(j=1:8, part="all", border=my_border) %>% 
  hline_bottom(j=1:8,part="body",  border=my_border) %>% 
  set_header_labels(z =" ", term= "Variable", composite_secMod= "Composite SEC moderator \n (OR[95% CIs]", 
                    nvq_secMod= "Parent education moderator \n (OR[95% CIs]",
                    income_secMod= "Income moderator \n (OR[95% CIs]",
                    occupation_secMod= "Occupational status moderator \n (OR[95% CIs]",
                    wealth_secMod= "Wealth moderator \n (OR[95% CIs]",
                    imd_secMod= "Relative neighbourhood deprivation moderator \n (OR[95% CIs]") %>% 
  merge_at(j=1, i = 2:3) %>% 
  merge_at(j=1, i=4:15) %>% 
  merge_at(j=1, i = 16:25) %>%
  merge_at(j=1, i = 26:33) %>% 
  merge_at(j=1, i=34:43) %>% 
  merge_at(j=1, i=44:63) %>% 
  rotate(i=2:3, j=1, rotation="btlr", align="center") %>% 
  rotate(i=4:15, j=1, rotation="btlr", align="center") %>% 
  rotate(i=16:25, j=1, rotation="btlr", align="center") %>% 
  rotate(i=26:33, j=1, rotation="btlr", align="center") %>% 
  rotate(i=34:33, j=1, rotation="btlr", align="center") %>% 
  rotate(i=44:63, j=1, rotation="btlr", align="center") %>% 
  align(j=1, align="center", part="all") 

 print(moderator_table2, preview = "docx") 
```

plots of predicted probabilities

```{r}
#plots of predicted probabilities####
#composite plot 

#regression model
compositeQuintiles_model <- function(df) {
  fit <- glm(success ~ sex + ethnicity + EAL + country +
               + standardised_caregiver_vocab + composite_quintiles*standardised_age5_vocab, 
             family = binomial, weights = weight, data=df)
  return(fit)
}


compositeQuintiles<- lapply(list(imputed_data1, imputed_data2, imputed_data3, imputed_data4, imputed_data5,
                                 imputed_data6, imputed_data7, imputed_data8, imputed_data9, imputed_data10,
                                 imputed_data11, imputed_data12, imputed_data13, imputed_data14, imputed_data15,
                                 imputed_data16, imputed_data17, imputed_data18, imputed_data19, imputed_data20,
                                 imputed_data21, imputed_data22, imputed_data23, imputed_data24, imputed_data25),
                            compositeQuintiles_model)

#get probabilities
composite_quintiles = lapply(compositeQuintiles, ggpredict, terms = c("standardised_age5_vocab[all]", "composite_quintiles"))

#nvq
nvq1 <- function(df) {
  fit <- glm(success ~ sex + ethnicity + EAL + country +
               oecd_income + occupational_status + wealth_quintiles + imd + 
               standardised_caregiver_vocab + highest_nvq*standardised_age5_vocab, 
             family = binomial, weights = weight, data=df)
  return(fit)
}
nvq_model <- lapply(list(imputed_data1, imputed_data2, imputed_data3, imputed_data4, imputed_data5,
                   imputed_data6, imputed_data7, imputed_data8, imputed_data9, imputed_data10,
                   imputed_data11, imputed_data12, imputed_data13, imputed_data14, imputed_data15,
                   imputed_data16, imputed_data17, imputed_data18, imputed_data19, imputed_data20,
                   imputed_data21, imputed_data22, imputed_data23, imputed_data24, imputed_data25),
              nvq1)
predicted_nvq = lapply(nvq_model, ggpredict, terms = c("standardised_age5_vocab[all]", "highest_nvq"))

#income 

income1 <- function(df) {
  fit <- glm(success ~ sex + ethnicity + EAL + country +
               highest_nvq+ occupational_status  + wealth_quintiles + imd + 
               standardised_caregiver_vocab + oecd_income*standardised_age5_vocab, 
             family = binomial, weights = weight, data=df)
  return(fit)
}
income_model <- lapply(list(imputed_data1, imputed_data2, imputed_data3, imputed_data4, imputed_data5,
                         imputed_data6, imputed_data7, imputed_data8, imputed_data9, imputed_data10,
                         imputed_data11, imputed_data12, imputed_data13, imputed_data14, imputed_data15,
                         imputed_data16, imputed_data17, imputed_data18, imputed_data19, imputed_data20,
                         imputed_data21, imputed_data22, imputed_data23, imputed_data24, imputed_data25),
                    income1)
predicted_income = lapply(income_model, ggpredict, terms = c("standardised_age5_vocab[all]", "oecd_income"))


#wealth
wealth1 <- function(df) {
  fit <- glm(success ~ sex + ethnicity + EAL + country +
               highest_nvq+ oecd_income + occupational_status   + imd + 
               standardised_caregiver_vocab + wealth_quintiles*standardised_age5_vocab, 
             family = binomial, weights = weight, data=df)
  return(fit)
}
wealth_model <- lapply(list(imputed_data1, imputed_data2, imputed_data3, imputed_data4, imputed_data5,
                            imputed_data6, imputed_data7, imputed_data8, imputed_data9, imputed_data10,
                            imputed_data11, imputed_data12, imputed_data13, imputed_data14, imputed_data15,
                            imputed_data16, imputed_data17, imputed_data18, imputed_data19, imputed_data20,
                            imputed_data21, imputed_data22, imputed_data23, imputed_data24, imputed_data25),
                       wealth1)
predicted_wealth = lapply(wealth_model, ggpredict, terms = c("standardised_age5_vocab[all]", "wealth_quintiles"))


#occupational status

occupation1 <- function(df) {
  fit <- glm(success ~ sex + ethnicity + EAL + country +
               highest_nvq + oecd_income  + wealth_quintiles + imd + 
               standardised_caregiver_vocab + occupational_status + standardised_age5_vocab, 
             family = binomial, weights = weight, data=df)
  return(fit)
}
occupation_model <- lapply(list(imputed_data1, imputed_data2, imputed_data3, imputed_data4, imputed_data5,
                            imputed_data6, imputed_data7, imputed_data8, imputed_data9, imputed_data10,
                            imputed_data11, imputed_data12, imputed_data13, imputed_data14, imputed_data15,
                            imputed_data16, imputed_data17, imputed_data18, imputed_data19, imputed_data20,
                            imputed_data21, imputed_data22, imputed_data23, imputed_data24, imputed_data25),
                       occupation1)
predicted_occupation = lapply(occupation_model, ggpredict, terms = c("standardised_age5_vocab[all]", "occupational_status"))





#IMD 


imd1 <- function(df) {
  fit <- glm(success ~ sex + ethnicity + EAL + country +
               highest_nvq + oecd_income + occupational_status  + wealth_quintiles + 
               standardised_caregiver_vocab + imd + standardised_age5_vocab, 
             family = binomial, weights = weight, data=df)
  return(fit)
}
imd_model <- lapply(list(imputed_data1, imputed_data2, imputed_data3, imputed_data4, imputed_data5,
                                imputed_data6, imputed_data7, imputed_data8, imputed_data9, imputed_data10,
                                imputed_data11, imputed_data12, imputed_data13, imputed_data14, imputed_data15,
                                imputed_data16, imputed_data17, imputed_data18, imputed_data19, imputed_data20,
                                imputed_data21, imputed_data22, imputed_data23, imputed_data24, imputed_data25),
                           imd1)
predicted_imd= lapply(imd_model, ggpredict, terms = c("standardised_age5_vocab[all]", "imd"))

#PLOTS####


#COMPOSITE QUINTILES - OWN PLOT FIGURE 1
compositeQuintiles_plot = plot(pool_predictions(composite_quintiles), ci = TRUE,
                               limits = c(0, 1), 
                               breaks = seq(0, 1, by = 0.1)) +
  scale_colour_manual(values=c("#054a91", "#6596c1","#9dbcd7" , "#f6a55c", "#f17300"), 
                      name="SEC Composite", 
                      breaks=c("1", "2", "3", "4", "5"),
                      labels=c("Lowest Quintile", "Quintile 2", "Quintile 3", "Quintile 4", "Highest Quintile"))+
  scale_fill_manual(values=c("#054a91", "#6596c1","#9dbcd7" , "#f6a55c", "#f17300"), 
                    name="SEC Composite",
                    breaks=c("1", "2", "3", "4", "5"),
                    labels=c("Lowest Quintile", "Quintile 2", "Quintile 3", "Quintile 4", "Highest Quintile")) +
  labs(x = "Age 5 Vocabulary Score \n (Standardised)", 
       y = "Achieving ≥ Grade 4 on Core Subjects ", 
       title = "Figure 1: Predicted Probabilities of Achieving the Benchmark Threshold for Vocabulary in each SEC Quintile",
       caption = "*Predicted probabilities when sex, ethnicity, EAL status and country set to reference levels and caregiver vocabulary score set to the mean.\n See table S9 for predicted values.") +
  labs(colour = "SEC Composite") +
  theme_classic() +
  scale_x_continuous(breaks=seq(-3, 4, .5)) +
  theme(panel.grid.major.y = element_line(colour = "gainsboro", size = 0.2),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(), 
        plot.title = element_text(size = 18, face = "italic", family = "Times"), 
        plot.caption = element_text(size = 14, face = "italic", family = "Times"),
        axis.text = element_text(size = 14, family = "Times"),
        axis.title = element_text(size = 16, family = "Times"),
        legend.text = element_text(size = 16, family= "Times"), 
        legend.title = element_text(size = 15, family = "Times")) 


ggsave("composite-moderator.png", compositeQuintiles_plot, width=13, height=10, units= "in" ,dpi=300)

#plot for combined plot with other indicators FIG2
compositeQuintiles_plot1 = plot(pool_predictions(composite_quintiles), ci = FALSE,
                                limits = c(0, 1), 
                                breaks = seq(0, 1, by = 0.1)) +
  scale_colour_manual(values=c("#054a91", "#6596c1","#9dbcd7" , "#f6a55c", "#f17300"), 
                      name="SEC Composite", 
                      breaks=c("1", "2", "3", "4", "5"),
                      labels=c("Lowest Quintile", "Quintile 2", "Quintile 3", "Quintile 4", "Highest Quintile"))+
  scale_fill_manual(values=c("#054a91", "#6596c1","#9dbcd7" , "#f6a55c", "#f17300"), 
                    name="SEC Composite",
                    breaks=c("1", "2", "3", "4", "5"),
                    labels=c("Lowest Quintile", "Quintile 2", "Quintile 3", "Quintile 4", "Highest Quintile")) +
  labs(x = "Age 5 Vocabulary Score \n (Standardised)", 
       y = "Achieving ≥ Grade 4 on Core Subjects ", 
       title = "SEC Composite") +
  labs(colour = "SEC Composite") +
  theme_classic() +
  scale_x_continuous(breaks=seq(-3, 4, .5)) +
   theme(panel.grid.major.y = element_line(colour = "gainsboro", size = 0.2),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(), 
        plot.title = element_text(size = 18, face = "italic", family = "Times"), 
        plot.caption = element_text(size = 14, face = "italic", family = "Times", hjust = 0),
        axis.text = element_text(size = 11, family = "Times"),
        axis.title.x = element_text(size = 16, family = "Times"),
        axis.title.y =  element_text(size = 12, family = "Times"),
        legend.text = element_text(size = 12, family= "Times"), 
        legend.title = element_text(size = 12, family = "Times"))


#nvq

nvq_plot = plot(pool_predictions(predicted_nvq), ci = FALSE,
                limits = c(0, 1), 
                breaks = seq(0, 1, by = 0.1)) +
  scale_colour_manual(values=c( "#054a91", "#6596c1", "#9dbcd7", "#f8b77d", "#f48f33", "#BDBDBD"), 
                      name="Parent Education",
                      breaks=c("1",  "2", "3", "4", "5","0"),
                      labels=c("NVQ1 (Lowest Qualifications)", "NVQ2", "NVQ3", "NVQ4", "NVQ5",  "No/ overseas qualifications"))+
  scale_fill_manual(values=c( "#054a91", "#6596c1", "#9dbcd7", "#f8b77d", "#f48f33", "#BDBDBD"), 
                    name="Parent Education",
                    breaks=c("1",  "2", "3", "4", "5","0"),
                    labels=c("NVQ1 (Lowest Qualifications)", "NVQ2", "NVQ3", "NVQ4", "NVQ5",  "No/ overseas qualifications")) +
  labs(x = "Age 5 Vocabulary Score \n (Standardised)", 
       y = "Achieving ≥ Grade 4 on Core Subjects ", 
       title = "Parent Education") +
  theme_classic() +
  scale_x_continuous(breaks=seq(-3, 4, .5)) +
    theme(panel.grid.major.y = element_line(colour = "gainsboro", size = 0.2),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(), 
        plot.title = element_text(size = 18, face = "italic", family = "Times"), 
        plot.caption = element_text(size = 14, face = "italic", family = "Times", hjust = 0),
        axis.text = element_text(size = 11, family = "Times"),
        axis.title.x = element_text(size = 16, family = "Times"),
        axis.title.y =  element_text(size = 12, family = "Times"),
        legend.text = element_text(size = 12, family= "Times"), 
        legend.title = element_text(size = 12, family = "Times"))



#income 
income_plot = plot(pool_predictions(predicted_income), ci = FALSE,
                   limits = c(0, 1), 
                   breaks = seq(0, 1, by = 0.1)) +
  scale_colour_manual(values=c("#054a91", "#6596c1","#9dbcd7" , "#f6a55c", "#f17300"), 
                      name="OECD Income",
                      breaks=c("1", "2", "3", "4", "5"),
                      labels=c("Lowest Quintile", "Quintile 2", "Quintile 3", "Quintile 4", "Highest Quintile"))+
  scale_fill_manual(values=c( "#054a91", "#6596c1","#9dbcd7" , "#f6a55c", "#f17300"), 
                    name="OECD Income",
                    breaks=c("1", "2", "3", "4", "5"),
                    labels=c("Lowest Quintile", "Quintile 2", "Quintile 3", "Quintile 4", "Highest Quintile")) +
  labs(x = "Age 5 Vocabulary Score \n (Standardised)", 
       y = "Achieving ≥ Grade 4 on Core Subjects ", 
       title = "Household Income  ") +
  theme_classic() +
  scale_x_continuous(breaks=seq(-3, 4, .5)) +
    theme(panel.grid.major.y = element_line(colour = "gainsboro", size = 0.2),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(), 
        plot.title = element_text(size = 18, face = "italic", family = "Times"), 
        plot.caption = element_text(size = 14, face = "italic", family = "Times", hjust = 0),
        axis.text = element_text(size = 11, family = "Times"),
        axis.title.x = element_text(size = 16, family = "Times"),
        axis.title.y =  element_text(size = 12, family = "Times"),
        legend.text = element_text(size = 12, family= "Times"), 
        legend.title = element_text(size = 12, family = "Times"))

#wealth
wealth_plot = plot(pool_predictions(predicted_wealth), ci = FALSE,
                   limits = c(0, 1), 
                   breaks = seq(0, 1, by = 0.1)) +
  scale_colour_manual(values=c( "#054a91", "#6596c1","#9dbcd7" , "#f6a55c", "#f17300"), 
                      name="Wealth Quintiles",
                      breaks=c("1", "2", "3", "4", "5"),
                      labels=c("Lowest Quintile", "Quintile 2", "Quintile 3", "Quintile 4", "Highest Quintile"))+
  scale_fill_manual(values=c( "#054a91", "#6596c1","#9dbcd7" , "#f6a55c", "#f17300"), 
                    name="Wealth Quintiles",
                    breaks=c("1", "2", "3", "4", "5"),
                    labels=c("Lowest Quintile", "Quintile 2", "Quintile 3", "Quintile 4", "Highest Quintile")) +
  labs(x = "Age 5 Vocabulary Score \n (Standardised)", 
       y = "Achieving ≥ Grade 4 on Core Subjects ", 
       title = "Household Wealth ") +
  theme_classic() +
  scale_x_continuous(breaks=seq(-3, 4, .5)) +
    theme(panel.grid.major.y = element_line(colour = "gainsboro", size = 0.2),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(), 
        plot.title = element_text(size = 18, face = "italic", family = "Times"), 
        plot.caption = element_text(size = 14, face = "italic", family = "Times", hjust = 0),
        axis.text = element_text(size = 11, family = "Times"),
        axis.title.x = element_text(size = 16, family = "Times"),
        axis.title.y =  element_text(size = 12, family = "Times"),
        legend.text = element_text(size = 12, family= "Times"), 
        legend.title = element_text(size = 12, family = "Times"))

#occupational status

occupation_plot = plot(pool_predictions(predicted_occupation), ci = FALSE,
                       limits = c(0, 1), 
                       breaks = seq(0, 1, by = 0.1)) +
  scale_colour_manual(values=c( "#054a91", "#6596c1", "#f6a55c", "#f17300"), 
                      name="Occupational Status",
                      breaks=c("1", "2",  "3", "4"),
                      labels=c("Unemployed", "Routine (Disadvantaged)", "Intermediate", "Higher Managerial (Advantaged)"))+
  scale_fill_manual(values=c( "#054a91", "#6596c1", "#f6a55c", "#f17300"), 
                    name="Occupational Status",
                    breaks=c("1", "2",  "3", "4"),
                    labels=c("Unemployed", "Routine (Disadvantaged)", "Intermediate", "Higher Managerial (Advantaged)")) +
  labs(x = "Age 5 Vocabulary Score \n (Standardised)", 
       y = "Achieving ≥ Grade 4 on Core Subjects ", 
       title = "Parent Occupational Status") +
  theme_classic() +
  scale_x_continuous(breaks=seq(-3, 4, .5)) +
    theme(panel.grid.major.y = element_line(colour = "gainsboro", size = 0.2),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(), 
        plot.title = element_text(size = 18, face = "italic", family = "Times"), 
        plot.caption = element_text(size = 14, face = "italic", family = "Times", hjust = 0),
        axis.text = element_text(size = 11, family = "Times"),
        axis.title.x = element_text(size = 16, family = "Times"),
        axis.title.y =  element_text(size = 12, family = "Times"),
        legend.text = element_text(size = 12, family= "Times"), 
        legend.title = element_text(size = 12, family = "Times"))

#IMD 

imd_plot = plot(pool_predictions(predicted_imd), ci = FALSE, 
                limits = c(0, 1), 
                breaks = seq(0, 1, by = 0.1)) +
  scale_colour_manual(values=c( "#054a91", "#3e7cb1", "#6596c1" ,"#84abcd", "#9dbcd7", 
                                "#f9c597", "#f8b77d" ,"#f6a55c", "#f48f33", "#f17300"), 
                      name="Relative Neighbourhood Deprivation",
                      labels=c("Most Deprived", "10 - <20%", "20 - <30%", "30 - <40%", "40 - <50%", 
                               "50 - <60%", "60 - <70%", "70 - <80%", "80 - <90%", "Least Deprived"))+
  scale_fill_manual(values=c(  "#054a91", "#3e7cb1", "#6596c1" ,"#84abcd", "#9dbcd7", 
                               "#f9c597", "#f8b77d" ,"#f6a55c", "#f48f33", "#f17300"), 
                    name="Relative Neighbourhood Deprivation",
                    labels=c("Most Deprived", "10 - <20%", "20 - <30%", "30 - <40%", "40 - <50%", 
                             "50 - <60%", "60 - <70%", "70 - <80%", "80 - <90%", "Least Deprived")) +
  labs(x = "Age 5 Vocabulary Score \n (Standardised)", 
       y = "Achieving ≥ Grade 4 on Core Subjects ", 
       title = "Relative Neighbourhood\n Deprivation") +
  theme_classic() +
  scale_x_continuous(breaks=seq(-3, 4, .5)) +
  theme(panel.grid.major.y = element_line(colour = "gainsboro", size = 0.2),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(), 
        plot.title = element_text(size = 18, face = "italic", family = "Times"), 
        plot.caption = element_text(size = 14, face = "italic", family = "Times", hjust = 0),
        axis.text = element_text(size = 11, family = "Times"),
        axis.title.x = element_text(size = 16, family = "Times"),
        axis.title.y =  element_text(size = 12, family = "Times"),
        legend.text = element_text(size = 12, family= "Times"), 
        legend.title = element_text(size = 12, family = "Times"))

#put plots all together 
plots = ggarrange(compositeQuintiles_plot1, nvq_plot, income_plot, occupation_plot, wealth_plot, imd_plot, 
                  ncol =2, nrow=3,  align = c( "hv"))

plots = annotate_figure(plots, top = text_grob("Figure 2: Predicted Probabilities of Achieving the Benchmark Threshold for Vocabulary Moderated by each SEC Indicator", 
                                               color = "black", face = "italic", size = 20, family = "Times"))

plots = plots + labs(caption ="*Predicted probabilities when categorical potential confounders (sex, ethnicity, EAL status, country and remaining SEC indicators for individual indicator moderations)\n set to reference levels and caregiver vocabulary score set to the mean.\n See table S9 for predicted probabilities values.") +
  theme(plot.caption = element_text(size = 16, face = "italic", family = "Times", hjust = 0))

ggsave("interaction-plots.png", plots, width=15, height=10, units= "in" ,dpi=300)

```



tables of predicted probabilities
```{r}
#tables of predicted probabilities####
composite_predictions = pool_predictions(composite_quintiles)
composite_predictions$predicted = bv(composite_predictions$predicted)
composite_predictions$conf.low = bv(composite_predictions$conf.low)
composite_predictions$conf.high = bv(composite_predictions$conf.high)
composite_predictions$value = paste0(composite_predictions$predicted, "[", composite_predictions$conf.low, ";", composite_predictions$conf.high, "]")

composite_predictions = composite_predictions %>% group_by(x) %>% 
  select(x, group, value) %>% 
pivot_wider(names_from = x, values_from = c("value")) %>% 
  select(group, `-2.97`, `-2`, `-0.94`, `0.12`, `2.32`) %>% 
  rename("SEC Indicator" = group) %>% 
  add_column(z = c("Composite Quintiles", " ", " ", " ", " "), .before = 1)
composite_predictions$`SEC Indicator`= c("Lowest Quintile", "Quintile 2", "Quintile 3", "Quintile 4", "Highest Quintiles")

#parent education
nvq_predictions = pool_predictions(predicted_nvq)
nvq_predictions$predicted = bv(nvq_predictions$predicted)
nvq_predictions$conf.low = bv(nvq_predictions$conf.low)
nvq_predictions$conf.high = bv(nvq_predictions$conf.high)
nvq_predictions$value = paste0(nvq_predictions$predicted, "[", nvq_predictions$conf.low, ";", nvq_predictions$conf.high, "]")

nvq_predictions = nvq_predictions %>% group_by(x) %>% 
  select(x, group, value) %>% 
pivot_wider(names_from = x, values_from = c("value")) %>% 
  select(group, `-2.97`, `-2`, `-0.94`, `0.12`, `2.32`) %>% 
  rename("SEC Indicator" = group) %>% 
  add_column(z = c("Parent Education (NVQ)", " ", " ", " ", " ", " "), .before = 1) 
nvq_predictions$`SEC Indicator` = c("NVQ1", "No qualifications/ \n overseas", "NVQ2", "NVQ3", "NVQ4", "NVQ5")
  
#income
income_predictions = pool_predictions(predicted_income)
income_predictions$predicted = bv(income_predictions$predicted)
income_predictions$conf.low = bv(income_predictions$conf.low)
income_predictions$conf.high = bv(income_predictions$conf.high)
income_predictions$value = paste0(income_predictions$predicted, "[", income_predictions$conf.low, ";", income_predictions$conf.high, "]")

income_predictions = income_predictions %>% group_by(x) %>% 
  select(x, group, value) %>% 
  pivot_wider(names_from = x, values_from = c("value")) %>% 
  select(group, `-2.97`, `-2`, `-0.94`, `0.12`, `2.32`) %>% 
  rename("SEC Indicator" = group) %>% 
  add_column(z = c("Income Quintiles", " ", " ", " ", " "), .before = 1) 
income_predictions$`SEC Indicator` = c("Lowest Quintile", "Quintile 2", "Quintile 3", "Quintile 4", "Highest Quintile")

#occupational status

occupation_predictions = pool_predictions(predicted_occupation)
occupation_predictions$predicted = bv(occupation_predictions$predicted)
occupation_predictions$conf.low = bv(occupation_predictions$conf.low)
occupation_predictions$conf.high = bv(occupation_predictions$conf.high)
occupation_predictions$value = paste0(occupation_predictions$predicted, "[", occupation_predictions$conf.low, ";", occupation_predictions$conf.high, "]")

occupation_predictions = occupation_predictions %>% group_by(x) %>% 
  select(x, group, value) %>% 
  pivot_wider(names_from = x, values_from = c("value")) %>% 
  select(group, `-2.97`, `-2`, `-0.94`, `0.12`, `2.32`) %>% 
  rename("SEC Indicator" = group) %>% 
  add_column(z = c("Occupational Status", " ", " ", " "), .before = 1) 
occupation_predictions$`SEC Indicator` = c("Routine (most deprived, ref)", "Unemployed", "Intermediate", "Higher Managerial (Least Deprived)")

#wealth 
wealth_predictions = pool_predictions(predicted_wealth)
wealth_predictions$predicted = bv(wealth_predictions$predicted)
wealth_predictions$conf.low = bv(wealth_predictions$conf.low)
wealth_predictions$conf.high = bv(wealth_predictions$conf.high)
wealth_predictions$value = paste0(wealth_predictions$predicted, "[", wealth_predictions$conf.low, ";", wealth_predictions$conf.high, "]")

wealth_predictions = wealth_predictions %>% group_by(x) %>% 
  select(x, group, value) %>% 
  pivot_wider(names_from = x, values_from = c("value")) %>% 
  select(group, `-2.97`, `-2`, `-0.94`, `0.12`, `2.32`) %>% 
  rename("SEC Indicator" = group) %>% 
  add_column(z = c("Wealth Quintiles", " ", " ", " ", " "), .before = 1) 
wealth_predictions$`SEC Indicator` = c("Lowest Quintile", "Quintile 2", "Quintile 3", "Quintile 4", "Highest Quintile")

#imd 
imd_predictions = pool_predictions(predicted_imd)
imd_predictions$predicted = bv(imd_predictions$predicted)
imd_predictions$conf.low = bv(imd_predictions$conf.low)
imd_predictions$conf.high = bv(imd_predictions$conf.high)
imd_predictions$value = paste0(imd_predictions$predicted, "[", imd_predictions$conf.low, ";", imd_predictions$conf.high, "]")

imd_predictions = imd_predictions %>% group_by(x) %>% 
  select(x, group, value) %>% 
  pivot_wider(names_from = x, values_from = c("value")) %>% 
  select(group, `-2.97`, `-2`, `-0.94`, `0.12`, `2.32`) %>% 
  rename("SEC Indicator" = group) %>% 
  add_column(z = c("Relative Neighbourhood Deprivation", " ", " ", " ", " ",
                   " ", " ", " ", " ", " "), .before = 1) 
imd_predictions$`SEC Indicator` = c("Most Deprived (ref)", "10 - <20%", "20 - <30%", "30 - <40%", "40 - <50%", 
                                    "50 - <60%", "60 - <70%", "70 - <80%", "80 - <90%", "Least Deprived")


predictions = rbind(composite_predictions, nvq_predictions, income_predictions, occupation_predictions, wealth_predictions, imd_predictions)
  
predicted_table <- predictions %>%
  flextable() %>% 
  font(fontname = "Times New Roman", part="all") %>% 
  fontsize(size=10, part = "all") %>% #
  align(j=2, align="left", part="all") %>% 
  align(j=3:7, align="center", part="all") %>% 
  color(j=1:7, color="black", part="all") %>% 
  width(j=2, width=1) %>% 
  width(j=3:7, width=1.4) %>% 
  line_spacing(j=3:7, space=1.5) %>% 
  line_spacing(j=2, space=1.5) %>% 
  merge_at(j=1, i=1:5) %>% 
  merge_at(j=1, i=6:11) %>% 
  merge_at(j=1, i=12:16) %>% 
  merge_at(j=1, i=17:20) %>% 
  merge_at(j=1, i=21:25) %>% 
  merge_at(j=1, i=26:35) %>% 
  rotate(i=1:5, j=1, rotation="btlr", align="center") %>% 
  rotate(i=6:11, j=1, rotation="btlr", align="center") %>% 
  rotate(i=12:16, j=1, rotation="btlr", align="center") %>% 
  rotate(i=17:20, j=1, rotation="btlr", align="center") %>% 
  rotate(i=21:25, j=1, rotation="btlr", align="center") %>% 
  rotate(i=26:35, j=1, rotation="btlr", align="center") %>% 
  add_header_row(values = c(" ", " ", "Age 5 Vocabulary Score (Standardised) \n Predicted Probability of Educational Attainment [95% CIs]"), colwidths = c(1, 1, 5)) %>% 
  border_remove() %>% 
  hline_top(j=2:7, part="all", border=my_border) %>% 
  hline_bottom(j=2:7,part="body",  border=my_border) %>% 
  set_header_labels(z =" ", term= "Variable") %>% 
  align(j=1, align="center", part="all") %>% 
  add_header_lines(values = c("Table S9: Predicted Probabilities of Educational Attainment (≥grade 4 on core subjects:Yes/No) for different values of Vocabulary in each SEC group"))

 print(predicted_table, preview = "docx") 
```




To control for potential confounding effects on the interaction term, all potential confounders and interaction terms between the potential confounders and the predictor, and potential confounders and the moderator, must be entered into the model (Keller, 2014). 
We therefore ran sensitivity analyses for our SEC* vocabulary moderations, whereby we included interaction terms between potential confounders (remaining SEC variables) and between the predictor (vocabulary) and potential confounders and the moderator (each SEC variable in turn), to ensure the confounding effect of SEC on the interaction term was accounted for. 

```{r}
#sensitivity check for interactions. ####
#1. parent education moderator 

#vocabulary*NVQ interaction term
NVQ_moderatorSensitivity = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                                          oecd_income*standardised_age5_vocab + oecd_income*highest_nvq + 
                                                    occupational_status*standardised_age5_vocab +occupational_status*highest_nvq +
                                                    wealth_quintiles*standardised_age5_vocab + wealth_quintiles*highest_nvq + 
                                                    imd*standardised_age5_vocab + imd*highest_nvq + 
                                         standardised_caregiver_vocab + highest_nvq*standardised_age5_vocab, 
                                         family = binomial, weights = weight))

NVQ_moderatorSensitivity_noInt = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                                          oecd_income*standardised_age5_vocab + oecd_income*highest_nvq + 
                                                    occupational_status*standardised_age5_vocab +occupational_status*highest_nvq +
                                                    wealth_quintiles*standardised_age5_vocab + wealth_quintiles*highest_nvq + 
                                                    imd*standardised_age5_vocab + imd*highest_nvq + 
                                         standardised_caregiver_vocab + highest_nvq + standardised_age5_vocab, 
                                         family = binomial, weights = weight))


#model comparison of interaction term vs without
D1(NVQ_moderatorSensitivity, NVQ_moderatorSensitivity_noInt)

#2. occupational status as the moderator 
#vocabulary*occupation interaction term
occupation_moderatorSensitivity = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                                           highest_nvq*standardised_age5_vocab + highest_nvq*occupational_status+
                                                           oecd_income*standardised_age5_vocab + oecd_income*occupational_status + 
                                                    wealth_quintiles*standardised_age5_vocab + wealth_quintiles*occupational_status + 
                                                    imd*standardised_age5_vocab + imd*occupational_status + 
                                         standardised_caregiver_vocab + occupational_status*standardised_age5_vocab, 
                                       family = binomial, weights = weight))

occupation_moderatorSensitivity_noInt = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                                           highest_nvq*standardised_age5_vocab + highest_nvq*occupational_status+
                                                           oecd_income*standardised_age5_vocab + oecd_income*occupational_status + 
                                                    wealth_quintiles*standardised_age5_vocab + wealth_quintiles*occupational_status + 
                                                    imd*standardised_age5_vocab + imd*occupational_status + 
                                         standardised_caregiver_vocab + occupational_status + standardised_age5_vocab, 
                                       family = binomial, weights = weight))

D1(occupation_moderatorSensitivity, occupation_moderatorSensitivity_noInt)


#3. income as the moderator 
#vocabulary*income interaction term
income_moderatorSensitivity = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                                       highest_nvq*standardised_age5_vocab + highest_nvq*oecd_income+
                                                    occupational_status*standardised_age5_vocab +occupational_status*oecd_income +
                                                    wealth_quintiles*standardised_age5_vocab + wealth_quintiles*oecd_income + 
                                                    imd*standardised_age5_vocab + imd*oecd_income + 
                                                      standardised_caregiver_vocab + oecd_income*standardised_age5_vocab, 
                                                    family = binomial, weights = weight))

income_moderatorSensitivity_noInt = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                                       highest_nvq*standardised_age5_vocab + highest_nvq*oecd_income+
                                                    occupational_status*standardised_age5_vocab +occupational_status*oecd_income +
                                                    wealth_quintiles*standardised_age5_vocab + wealth_quintiles*oecd_income + 
                                                    imd*standardised_age5_vocab + imd*oecd_income + 
                                                      standardised_caregiver_vocab + oecd_income + standardised_age5_vocab, 
                                                    family = binomial, weights = weight))

D1(income_moderatorSensitivity, income_moderatorSensitivity_noInt)

#4. wealth as the moderator 
#vocabulary*wealth interaction term
wealth_moderatorSensitivity = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                            highest_nvq*standardised_age5_vocab + highest_nvq*wealth_quintiles +
                                              oecd_income*standardised_age5_vocab + oecd_income*wealth_quintiles + 
                                              occupational_status*standardised_age5_vocab + occupational_status*wealth_quintiles +
                                              imd*standardised_age5_vocab + imd*wealth_quintiles + 
                                            standardised_caregiver_vocab + wealth_quintiles*standardised_age5_vocab, 
                                          family = binomial, weights = weight))

wealth_moderatorSensitivity_noInt = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                            highest_nvq*standardised_age5_vocab + highest_nvq*wealth_quintiles +
                                              oecd_income*standardised_age5_vocab + oecd_income*wealth_quintiles + 
                                              occupational_status*standardised_age5_vocab + occupational_status*wealth_quintiles +
                                              imd*standardised_age5_vocab + imd*wealth_quintiles + 
                                            standardised_caregiver_vocab + wealth_quintiles + standardised_age5_vocab, 
                                          family = binomial, weights = weight))

D1(wealth_moderatorSensitivity, wealth_moderatorSensitivity_noInt)

#5. imd as the moderator 
#vocabulary*wealth interaction term
imd_moderatorSensitivity  = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                            highest_nvq*standardised_age5_vocab + highest_nvq*imd +
                                              oecd_income*standardised_age5_vocab + oecd_income*imd + 
                                              occupational_status*standardised_age5_vocab +occupational_status*imd +
                                              wealth_quintiles*standardised_age5_vocab + wealth_quintiles*imd + 
                                            standardised_caregiver_vocab + imd*standardised_age5_vocab, 
                                          family = binomial, weights = weight))

imd_moderatorSensitivity_noInt  = with(imputed_mcs2, glm(success ~ sex + ethnicity + EAL + country +
                                            highest_nvq*standardised_age5_vocab + highest_nvq*imd +
                                              oecd_income*standardised_age5_vocab + oecd_income*imd + 
                                              occupational_status*standardised_age5_vocab +occupational_status*imd +
                                              wealth_quintiles*standardised_age5_vocab + wealth_quintiles*imd + 
                                            standardised_caregiver_vocab + imd + standardised_age5_vocab, 
                                          family = binomial, weights = weight))

D1(imd_moderatorSensitivity, imd_moderatorSensitivity_noInt)

```

